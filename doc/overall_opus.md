# easyFactu Architecture Overview

> æœ¬æ–‡æ¡£æä¾›ä»£ç åº“çš„ç³»ç»Ÿæ¶æ„æ·±åº¦åˆ†æï¼ŒåŒ…æ‹¬è®¾è®¡æ¨¡å¼ã€æ•°æ®æµã€æ¨¡å—è¾¹ç•Œä¸å…³é”®å®ç°ç»†èŠ‚ã€‚

---

## ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
3. [ç›®å½•ç»“æ„ä¸æ¨¡å—è¾¹ç•Œ](#3-ç›®å½•ç»“æ„ä¸æ¨¡å—è¾¹ç•Œ)
4. [è®¤è¯ä¸å®‰å…¨](#4-è®¤è¯ä¸å®‰å…¨)
5. [æ•°æ®å±‚æ¶æ„](#5-æ•°æ®å±‚æ¶æ„)
6. [æ ¸å¿ƒä¸šåŠ¡æ¨¡å—](#6-æ ¸å¿ƒä¸šåŠ¡æ¨¡å—)
7. [å‰åç«¯äº¤äº’æ¨¡å¼](#7-å‰åç«¯äº¤äº’æ¨¡å¼)
8. [çŠ¶æ€ç®¡ç†ç­–ç•¥](#8-çŠ¶æ€ç®¡ç†ç­–ç•¥)
9. [å…³é”®ä¸šåŠ¡æµç¨‹](#9-å…³é”®ä¸šåŠ¡æµç¨‹)
10. [ç¯å¢ƒé…ç½®ä¸éƒ¨ç½²](#10-ç¯å¢ƒé…ç½®ä¸éƒ¨ç½²)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

easyFactu æ˜¯ä¸€ä¸ªåŸºäº Next.js App Router çš„é¤é¥® POSï¼ˆé”€å”®ç‚¹ï¼‰ç³»ç»Ÿï¼Œé¢å‘ä¸­å°å‹é¤å…æä¾›å®Œæ•´çš„ç‚¹å•ã€ç»“è´¦ã€æ¡Œå°ç®¡ç†ä¸è´¢åŠ¡è¿½è¸ªèƒ½åŠ›ã€‚

### æ ¸å¿ƒåŠŸèƒ½çŸ©é˜µ

| æ¨¡å— | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| **POS** | ç‚¹å•ã€æ‰¹æ¬¡ç®¡ç†ã€AAç»“è´¦ã€æ•´å•ç»“è´¦ã€æ‰“å°å°ç¥¨ | âœ… å®Œæ•´ |
| **æ¡Œå°** | CRUDã€çŠ¶æ€ç®¡ç†ã€æ‹†å°/å¹¶å° | âœ… å®Œæ•´ |
| **èœå•** | CRUDã€åˆ†ç±»ç®¡ç†ã€è½¯åˆ é™¤ | âœ… å®Œæ•´ |
| **è´¢åŠ¡** | äº¤æ˜“è®°å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ | âœ… åŸºç¡€ |
| **æŠ¥è¡¨** | æ•°æ®å±•ç¤º | ğŸš§ UI å·²å»ºï¼Œæ•°æ®å¾…æ¥å…¥ |
| **è®¾ç½®** | ç³»ç»Ÿé…ç½® | ğŸš§ UI å·²å»º |

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 æŠ€æœ¯æ ˆå…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend                              â”‚
â”‚  Next.js 16 (App Router) + React 19 + TypeScript            â”‚
â”‚  Tailwind CSS 4 + shadcn/ui + Radix UI                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API Layer                                â”‚
â”‚  Next.js Route Handlers (app/api/**/route.ts)               â”‚
â”‚  Zod Schema Validation                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Access                               â”‚
â”‚  Drizzle ORM + node-postgres (pg)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Database                                  â”‚
â”‚  PostgreSQL (Supabase hosted)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Authentication                              â”‚
â”‚  Supabase Auth (@supabase/ssr)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒä¾èµ–

| ç±»åˆ« | ä¾èµ– | ç”¨é€” |
|------|------|------|
| Framework | `next@16`, `react@19` | åº”ç”¨æ¡†æ¶ |
| ORM | `drizzle-orm`, `pg` | æ•°æ®åº“è®¿é—® |
| Auth | `@supabase/ssr`, `@supabase/supabase-js` | è®¤è¯ |
| UI | `@radix-ui/*`, `shadcn/ui` | ç»„ä»¶åº“ |
| Validation | `zod` | è¯·æ±‚ä½“æ ¡éªŒ |
| Styling | `tailwindcss@4`, `tailwind-merge` | æ ·å¼ |
| Utils | `date-fns`, `lucide-react`, `recharts` | å·¥å…·åº“ |

---

## 3. ç›®å½•ç»“æ„ä¸æ¨¡å—è¾¹ç•Œ

```
easyFactu/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ layout.tsx                # æ ¹å¸ƒå±€ï¼ˆThemeProviderï¼‰
â”‚   â”œâ”€â”€ page.tsx                  # é¦–é¡µå…¥å£
â”‚   â”œâ”€â”€ dashboard/                # ç»è¥çœ‹æ¿
â”‚   â”œâ”€â”€ pos/                      # POS ç‚¹å•ç•Œé¢
â”‚   â”œâ”€â”€ tables/                   # æ¡Œå°ç®¡ç†
â”‚   â”œâ”€â”€ menu/                     # èœå•ç®¡ç†
â”‚   â”œâ”€â”€ finance/                  # è´¢åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ reports/                  # æŠ¥è¡¨
â”‚   â”œâ”€â”€ settings/                 # è®¾ç½®
â”‚   â”œâ”€â”€ auth/                     # è®¤è¯é¡µé¢
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”œâ”€â”€ sign-up/
â”‚   â”‚   â”œâ”€â”€ forgot-password/
â”‚   â”‚   â””â”€â”€ confirm/route.ts      # OAuth callback
â”‚   â””â”€â”€ api/                      # Route Handlers
â”‚       â”œâ”€â”€ menu-items/           # èœå• API
â”‚       â”œâ”€â”€ restaurant-tables/    # æ¡Œå° API
â”‚       â””â”€â”€ orders/               # è®¢å• API
â”‚           â”œâ”€â”€ route.ts          # åˆ›å»º/æŸ¥è¯¢è®¢å•
â”‚           â”œâ”€â”€ [id]/route.ts     # ä¿®æ”¹è®¢å•
â”‚           â”œâ”€â”€ checkout/         # ç»“è´¦
â”‚           â”œâ”€â”€ clear/            # æ¸…ç©ºè®¢å•
â”‚           â””â”€â”€ transfer/         # æ‹†å°/å¹¶å°
â”‚
â”œâ”€â”€ components/                   # React ç»„ä»¶
â”‚   â”œâ”€â”€ ui/                       # shadcn åŸºç¡€ç»„ä»¶
â”‚   â”œâ”€â”€ pos-interface.tsx         # POS ä¸»ç•Œé¢
â”‚   â”œâ”€â”€ dashboard-layout.tsx      # åå° Shell
â”‚   â”œâ”€â”€ menu-management.tsx       # èœå•ç®¡ç†
â”‚   â”œâ”€â”€ table-management.tsx      # æ¡Œå°ç®¡ç†
â”‚   â””â”€â”€ ...                       # å…¶ä»–ä¸šåŠ¡ç»„ä»¶
â”‚
â”œâ”€â”€ hooks/                        # è‡ªå®šä¹‰ Hooks
â”‚   â”œâ”€â”€ useMenuData.ts            # èœå•æ•°æ®
â”‚   â”œâ”€â”€ useRestaurantTables.ts    # æ¡Œå°æ•°æ®
â”‚   â”œâ”€â”€ usePosOrder.ts            # POS è®¢å•çŠ¶æ€
â”‚   â”œâ”€â”€ useCheckout.ts            # ç»“è´¦çŠ¶æ€æœº
â”‚   â””â”€â”€ useTableTransfer.ts       # æ‹†å¹¶å°
â”‚
â”œâ”€â”€ db/
â”‚   â””â”€â”€ schema.ts                 # Drizzle Schema å®šä¹‰
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ db.ts                     # æ•°æ®åº“è¿æ¥æ± 
â”‚   â”œâ”€â”€ money.ts                  # é‡‘é¢å¤„ç†å·¥å…·
â”‚   â”œâ”€â”€ order-utils.ts            # è®¢å•æ‰¹æ¬¡èšåˆ
â”‚   â””â”€â”€ supabase/                 # Supabase å®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ client.ts             # æµè§ˆå™¨ç«¯
â”‚       â”œâ”€â”€ server.ts             # æœåŠ¡ç«¯
â”‚       â””â”€â”€ middleware.ts         # Session åˆ·æ–°
â”‚
â”œâ”€â”€ drizzle/                      # è¿ç§»æ–‡ä»¶
â”œâ”€â”€ seed/                         # CSV ç§å­æ•°æ®
â”œâ”€â”€ types/                        # TypeScript ç±»å‹
â””â”€â”€ middleware.ts                 # Next.js ä¸­é—´ä»¶å…¥å£
```

### æ¨¡å—èŒè´£è¾¹ç•Œ

| å±‚çº§ | èŒè´£ | ä¾èµ–æ–¹å‘ |
|------|------|----------|
| `app/` | è·¯ç”±ã€é¡µé¢æ¸²æŸ“ã€Route Handlers | â†’ components, hooks, lib |
| `components/` | UI æ¸²æŸ“ã€ç”¨æˆ·äº¤äº’ | â†’ hooks, lib |
| `hooks/` | æ•°æ®è·å–ã€çŠ¶æ€ç®¡ç† | â†’ lib (fetch) |
| `lib/` | åŸºç¡€è®¾æ–½ï¼ˆDBã€Authã€Utilsï¼‰ | â†’ db/schema |
| `db/` | æ•°æ®æ¨¡å‹å®šä¹‰ | æ— ä¾èµ– |

---

## 4. è®¤è¯ä¸å®‰å…¨

### 4.1 è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚â”€â”€â”€â”€â–¶â”‚   middleware.ts â”‚â”€â”€â”€â”€â–¶â”‚  updateSessionâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚  getClaims()  â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â–¼                                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æœ‰æ•ˆ Session   â”‚                         â”‚   æ—  Session    â”‚
                    â”‚   ç»§ç»­è®¿é—®       â”‚                         â”‚ é‡å®šå‘åˆ° /auth  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è·¯ç”±ä¿æŠ¤ç­–ç•¥

- **Middleware çº§åˆ«**: `middleware.ts` æ‹¦æˆªæ‰€æœ‰éé™æ€èµ„æºè¯·æ±‚
- **é¡µé¢çº§åˆ«**: `app/dashboard/page.tsx` ç­‰æœåŠ¡ç«¯é¡µé¢å†æ¬¡æ ¡éªŒ
- **ç™½åå•è·¯å¾„**: `/auth/*` å…è®¸æœªè®¤è¯è®¿é—®

### 4.3 Session ç®¡ç†

```typescript
// lib/supabase/middleware.ts
const { data } = await supabase.auth.getClaims();
const user = data?.claims;

if (!user && !request.nextUrl.pathname.startsWith("/auth")) {
  return NextResponse.redirect("/auth/login");
}
```

---

## 5. æ•°æ®å±‚æ¶æ„

### 5.1 å®ä½“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  menu_items   â”‚       â”‚restaurant_tablesâ”‚     â”‚  transactions â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)       â”‚       â”‚ id (PK)       â”‚       â”‚ id (PK)       â”‚
â”‚ name          â”‚       â”‚ number        â”‚       â”‚ type          â”‚
â”‚ nameEn        â”‚       â”‚ area          â”‚       â”‚ category      â”‚
â”‚ category      â”‚       â”‚ capacity      â”‚       â”‚ amount        â”‚
â”‚ price         â”‚       â”‚ status        â”‚       â”‚ paymentMethod â”‚
â”‚ available     â”‚       â”‚ amount        â”‚       â”‚ orderId (FK)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ currentGuests â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â–²
        â”‚                       â”‚                       â”‚
        â”‚                       â”‚                       â”‚
        â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
        â”‚               â”‚    orders     â”‚               â”‚
        â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
        â”‚               â”‚ id (PK)       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚ tableId (FK)  â”‚
        â”‚               â”‚ status        â”‚
        â”‚               â”‚ totalAmount   â”‚
        â”‚               â”‚ paidAmount    â”‚
        â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
        â”‚                       â”‚ 1:N
        â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚  order_items  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
             N:1        â”‚ id (PK)       â”‚
                        â”‚ orderId (FK)  â”‚
                        â”‚ menuItemId(FK)â”‚
                        â”‚ quantity      â”‚
                        â”‚ paidQuantity  â”‚
                        â”‚ batchNo       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ ¸å¿ƒè¡¨è®¾è®¡

#### menu_itemsï¼ˆèœå“ï¼‰
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | uuid | ä¸»é”® |
| name | text | ä¸­æ–‡å |
| nameEn | text | è‹±æ–‡å |
| category | text | åˆ†ç±» |
| price | numeric(12,2) | ä»·æ ¼ |
| available | boolean | æ˜¯å¦å¯å”®ï¼ˆè½¯åˆ é™¤ï¼‰ |

#### restaurant_tablesï¼ˆæ¡Œå°ï¼‰
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | uuid | ä¸»é”® |
| number | text | æ¡Œå· |
| status | enum | idle/occupied |
| amount | numeric(12,2) | æœªç»“é‡‘é¢ï¼ˆç¼“å­˜ï¼‰ |

#### ordersï¼ˆè®¢å•ï¼‰
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | uuid | ä¸»é”® |
| tableId | uuid | å…³è”æ¡Œå° |
| status | enum | open/paid/cancelled |
| totalAmount | numeric(12,2) | è®¢å•æ€»é¢ |
| paidAmount | numeric(12,2) | å·²ä»˜é‡‘é¢ |

**å…³é”®çº¦æŸ**: é€šè¿‡éƒ¨åˆ†å”¯ä¸€ç´¢å¼•ç¡®ä¿æ¯æ¡Œæœ€å¤šä¸€ä¸ª open è®¢å•ï¼š
```sql
CREATE UNIQUE INDEX uniq_open_order_per_table 
ON orders(table_id) WHERE status = 'open';
```

#### order_itemsï¼ˆè®¢å•æ˜ç»†ï¼‰
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| quantity | integer | ç‚¹å•æ•°é‡ |
| paidQuantity | integer | å·²ä»˜æ•°é‡ï¼ˆAA ç»“è´¦æ ¸å¿ƒï¼‰ |
| batchNo | integer | æ‰¹æ¬¡å· |

### 5.3 è¿æ¥æ± ç®¡ç†

```typescript
// lib/db.ts
const globalForDrizzle = globalThis as unknown as {
  __drizzle_pool__?: Pool;
};

// å¤ç”¨è¿æ¥æ± é¿å… HMR æ—¶é‡å¤åˆ›å»º
if (!globalForDrizzle.__drizzle_pool__) {
  globalForDrizzle.__drizzle_pool__ = new Pool({
    connectionString: process.env.DATABASE_URL,
  });
}
```

---

## 6. æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

### 6.1 POS æ¨¡å—

POS æ˜¯ç³»ç»Ÿæ ¸å¿ƒï¼Œè´Ÿè´£ç‚¹å•ã€ç»“è´¦ã€æ‰“å°å…¨æµç¨‹ã€‚

#### ç»„ä»¶æ¶æ„
```
POSInterface
â”œâ”€â”€ PosMenuPane          # å·¦ä¾§èœå•é€‰æ‹©åŒº
â”œâ”€â”€ PosOrderSidebar      # å³ä¾§è®¢å•/è´­ç‰©è½¦
â”œâ”€â”€ PosCheckoutDialog    # ç»“è´¦å¼¹çª—
â”œâ”€â”€ SplitTableDialog     # æ‹†å°å¼¹çª—
â”œâ”€â”€ MergeTableDialog     # å¹¶å°å¼¹çª—
â””â”€â”€ PosReceiptPreview    # æ‰“å°é¢„è§ˆ
```

#### çŠ¶æ€æµè½¬
```
é€‰æ‹©æ¡Œå° â†’ æ·»åŠ èœå“åˆ° Cart â†’ ä¸‹å•(æäº¤æ‰¹æ¬¡) â†’ ç»“è´¦/AA â†’ æ‰“å°
     â†‘                              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€ æ”¹èœ/æ¸…ç©º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç»“è´¦æ¨¡å—

æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

| æ¨¡å¼ | è¯´æ˜ | å®ç° |
|------|------|------|
| **Full** | æ•´å•ç»“è´¦ | æ‰€æœ‰ order_items.paidQuantity = quantity |
| **AA** | åˆ†å•ç»“è´¦ | æŒ‰é€‰ä¸­èœå“æ•°é‡é€’å¢ paidQuantity |

#### AA ç»“è´¦ç®—æ³•
```typescript
// 1. æŒ‰ menuItemId èšåˆè®¢å•ä¸­çš„æœªä»˜èœå“
// 2. åˆ†é… AA é€‰ä¸­çš„æ•°é‡åˆ°å…·ä½“è¡Œ
// 3. æ›´æ–° paidQuantityï¼ˆä¸åˆ é™¤è¡Œï¼‰
// 4. å¦‚æœæ‰€æœ‰èœå“éƒ½å·²ä»˜ â†’ è®¢å•çŠ¶æ€å˜ paid
// 5. å¦åˆ™ä¿æŒ openï¼Œç»§ç»­æœåŠ¡
```

### 6.3 æ¡Œå°ç®¡ç†

#### æ‹†å°/å¹¶å°æµç¨‹
```
æ‹†å°: æºæ¡Œå° â†’ é€‰æ‹©èœå“ â†’ ç›®æ ‡æ¡Œå°
      - æºæ¡Œè®¢å•å‡å°‘å¯¹åº” items
      - ç›®æ ‡æ¡Œè‡ªåŠ¨åˆ›å»º/è¿½åŠ è®¢å•

å¹¶å°: æºæ¡Œå° â†’ ç›®æ ‡æ¡Œå°
      - å°†æºæ¡Œè®¢å• items å…¨éƒ¨è½¬ç§»
      - æºæ¡Œè®¢å•æ¸…ç©ºæˆ–å–æ¶ˆ
```

---

## 7. å‰åç«¯äº¤äº’æ¨¡å¼

### 7.1 æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      React Component                             â”‚
â”‚                            â”‚                                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚  Custom Hook   â”‚                            â”‚
â”‚                    â”‚ (useMenuData)  â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                            â”‚ fetch()                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Route Handler                                 â”‚
â”‚                   (app/api/.../route.ts)                        â”‚
â”‚                            â”‚                                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚  Zod Validate  â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                            â”‚                                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚  Drizzle ORM   â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    PostgreSQL   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 API ç«¯ç‚¹æ¸…å•

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/menu-items` | GET | è·å–èœå“åˆ—è¡¨ |
| `/api/menu-items` | POST | åˆ›å»ºèœå“ |
| `/api/menu-items/[id]` | DELETE | è½¯åˆ é™¤èœå“ |
| `/api/restaurant-tables` | GET | è·å–æ¡Œå°åˆ—è¡¨ |
| `/api/restaurant-tables` | POST | åˆ›å»ºæ¡Œå° |
| `/api/restaurant-tables/[id]` | PATCH | æ›´æ–°æ¡Œå° |
| `/api/restaurant-tables/[id]` | DELETE | åˆ é™¤æ¡Œå° |
| `/api/orders` | GET | æŸ¥è¯¢è®¢å• |
| `/api/orders` | POST | åˆ›å»ºè®¢å•/æ·»åŠ æ‰¹æ¬¡ |
| `/api/orders/[id]` | PATCH | ä¿®æ”¹è®¢å• |
| `/api/orders/checkout` | POST | ç»“è´¦ |
| `/api/orders/clear` | POST | æ¸…ç©ºè®¢å• |
| `/api/orders/transfer` | POST | æ‹†å°/å¹¶å° |

### 7.3 é”™è¯¯å¤„ç†

ç»Ÿä¸€é”™è¯¯ç æ˜ å°„ï¼š
```typescript
const errorCodeToMessage: Record<string, string> = {
  SUBTOTAL_MISMATCH: "è®¢å•é‡‘é¢å·²åœ¨å…¶ä»–ç»ˆç«¯æ›´æ–°...",
  AA_QUANTITY_EXCEEDS_ORDER: "AA ä»½æ•°è¶…è¿‡è®¢å•ä¸­å¯åˆ†é…çš„æ•°é‡...",
  INSUFFICIENT_RECEIVED_AMOUNT: "æ”¶æ¬¾é‡‘é¢ä¸è¶³...",
  // ...
};
```

---

## 8. çŠ¶æ€ç®¡ç†ç­–ç•¥

### 8.1 Hook å±‚çŠ¶æ€ç®¡ç†

| Hook | çŠ¶æ€ | èŒè´£ |
|------|------|------|
| `usePosOrder` | currentOrder, batches | è®¢å•æ•°æ®ã€æ‰¹æ¬¡æäº¤ |
| `useCheckout` | checkoutState, aaItems | ç»“è´¦æµç¨‹çŠ¶æ€æœº |
| `useMenuData` | items, categories | èœå•æ•°æ®ç¼“å­˜ |
| `useRestaurantTables` | tables | æ¡Œå°åˆ—è¡¨ |

### 8.2 ä¹è§‚æ›´æ–° vs æœåŠ¡ç«¯éªŒè¯

- **UI å±‚**: ä¹è§‚æ˜¾ç¤ºè®¡ç®—ç»“æœ
- **æäº¤æ—¶**: æœåŠ¡ç«¯é‡æ–°è®¡ç®—å¹¶æ ¡éªŒ
- **å†²çªå¤„ç†**: è¿”å›é”™è¯¯ç ï¼Œå‰ç«¯å±•ç¤ºå‹å¥½æç¤º

```typescript
// ç»“è´¦æ—¶çš„åŒå‘æ ¡éªŒ
if (Math.abs(clientSubtotal - serverSubtotal) > epsilon) {
  return { error: "SUBTOTAL_MISMATCH" };
}
```

---

## 9. å…³é”®ä¸šåŠ¡æµç¨‹

### 9.1 å®Œæ•´ç‚¹å•æµç¨‹

```
1. ç”¨æˆ·è¿›å…¥ POS é¡µé¢ (/pos?tableId=xxx)
2. useRestaurantTables åŠ è½½æ¡Œå°åˆ—è¡¨
3. usePosOrder æ ¹æ® tableId åŠ è½½å½“å‰è®¢å•
4. ç”¨æˆ·é€‰æ‹©èœå“ â†’ æ·»åŠ åˆ° cart (æœ¬åœ°çŠ¶æ€)
5. ç‚¹å‡»ã€Œä¸‹å•ã€â†’ POST /api/orders
   - æœåŠ¡ç«¯åˆ›å»º/å¤ç”¨ open è®¢å•
   - æ’å…¥ order_items (æ–°æ‰¹æ¬¡å·)
   - æ›´æ–°æ¡Œå° status=occupied, amount
6. å‰ç«¯æ¸…ç©º cartï¼Œåˆ·æ–° batches
```

### 9.2 AA ç»“è´¦æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»ã€ŒAAã€æŒ‰é’®
2. è¿›å…¥ AA æ¨¡å¼ï¼Œæ˜¾ç¤ºå¯é€‰èœå“åˆ—è¡¨
3. ç”¨æˆ·é€‰æ‹©è¦ç»“è´¦çš„èœå“å’Œæ•°é‡
4. å‰ç«¯è®¡ç®— checkoutSubtotal, checkoutTotal
5. æäº¤ POST /api/orders/checkout (mode=aa)
6. æœåŠ¡ç«¯:
   a. æŒ‰ menuItemId åˆ†é…æ•°é‡åˆ°å…·ä½“ order_items
   b. æ›´æ–° paidQuantity
   c. è®¡ç®—å‰©ä½™æœªä»˜é‡‘é¢
   d. è‹¥å…¨éƒ¨ä»˜æ¸… â†’ status=paid, æ¡Œå° idle
   e. å†™å…¥ transaction è®°å½•
7. å‰ç«¯æ‰“å° AA å°ç¥¨
```

### 9.3 æ‹†å°æµç¨‹

```
1. ç”¨æˆ·é€‰æ‹©æºæ¡Œå°ï¼Œç‚¹å‡»ã€Œæ‹†å°ã€
2. é€‰æ‹©ç›®æ ‡æ¡Œå°å’Œè¦è½¬ç§»çš„èœå“
3. POST /api/orders/transfer
4. æœåŠ¡ç«¯:
   a. ä»æºè®¢å•å‡å°‘å¯¹åº” items
   b. åœ¨ç›®æ ‡æ¡Œåˆ›å»º/è¿½åŠ è®¢å•
   c. æ›´æ–°ä¸¤ä¸ªæ¡Œå°çš„ amount
5. å‰ç«¯åˆ·æ–°è®¢å•å’Œæ¡Œå°çŠ¶æ€
```

---

## 10. ç¯å¢ƒé…ç½®ä¸éƒ¨ç½²

### 10.1 å¿…éœ€ç¯å¢ƒå˜é‡

```bash
# Supabase é…ç½®
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=eyJ...

# æ•°æ®åº“è¿æ¥ï¼ˆSupabase Postgresï¼‰
DATABASE_URL=postgresql://postgres:xxx@db.xxx.supabase.co:5432/postgres
```

### 10.2 å¼€å‘å‘½ä»¤

```bash
pnpm dev              # å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (Turbopack)
pnpm build            # ç”Ÿäº§æ„å»º
pnpm lint             # ESLint æ£€æŸ¥
pnpm drizzle:generate # ç”Ÿæˆè¿ç§» SQL
pnpm drizzle:push     # æ¨é€è¿ç§»åˆ°æ•°æ®åº“
pnpm drizzle:studio   # å¯è§†åŒ–æ•°æ®åº“ç®¡ç†
```

### 10.3 éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**: éƒ¨ç½²å‰æ‰§è¡Œ `drizzle:push`
2. **ç¯å¢ƒå˜é‡**: ç¡®ä¿ç”Ÿäº§ç¯å¢ƒé…ç½®æ­£ç¡®çš„ Supabase å‡­è¯
3. **è¿æ¥æ± **: ç”Ÿäº§ç¯å¢ƒå¯èƒ½éœ€è¦è°ƒæ•´ Pool é…ç½®
4. **æ‰“å°åŠŸèƒ½**: ä¾èµ–æµè§ˆå™¨ `window.print()`ï¼Œéœ€ç¡®ä¿æ ·å¼å…¼å®¹

---

## é™„å½•ï¼šè®¾è®¡å†³ç­–è®°å½•

| å†³ç­– | åŸå›  |
|------|------|
| ä½¿ç”¨ Route Handlers è€Œé Server Actions | æ›´æ¸…æ™°çš„ API è¾¹ç•Œï¼Œä¾¿äºè°ƒè¯• |
| paidQuantity å­—æ®µè®¾è®¡ | æ”¯æŒ AA åˆ†å•ç»“è´¦ï¼Œä¿ç•™å®Œæ•´ç‚¹å•å†å² |
| batchNo æ‰¹æ¬¡è®¾è®¡ | åŒºåˆ†å¤šæ¬¡ç‚¹å•ï¼Œä¾¿äºæœåŠ¡å‘˜ç¡®è®¤æ–°å¢èœå“ |
| éƒ¨åˆ†å”¯ä¸€ç´¢å¼• | æ•°æ®åº“çº§åˆ«ä¿è¯ä¸šåŠ¡è§„åˆ™ |
| é‡‘é¢ä½¿ç”¨ numeric(12,2) | é¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜ |
| æ¡Œå° amount å­—æ®µ | ç¼“å­˜æœªç»“é‡‘é¢ï¼Œå‡å°‘èšåˆæŸ¥è¯¢ |
