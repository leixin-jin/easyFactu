# easyFactu æ¶æ„è¯„å®¡ v3ï¼ˆç»ˆæç»¼åˆç‰ˆï¼‰

> **ç‰ˆæœ¬**: v3.0  
> **æ—¥æœŸ**: 2025-12-26  
> **ç›®æ ‡è¯»è€…**: æ–°åŠ å…¥å›¢é˜Ÿçš„å¼€å‘è€… & è´Ÿè´£é‡æ„çš„å·¥ç¨‹å¸ˆ  
> **æ ¸å¿ƒç›®æ ‡**: 30 åˆ†é’Ÿè¯»æ‡‚ä¸»æµç¨‹ï¼Œä»»åŠ¡å¯ç›´æ¥æ‹†åˆ†å¹¶è¡Œæ¨è¿›

---

## ğŸ“– é˜…è¯»æŒ‡å—

æœ¬æ–‡æ¡£ç»¼åˆäº† **Codex v2**ï¼ˆä»»åŠ¡æ‹†è§£æ¸…æ™°ã€ä¼˜å…ˆçº§æ˜ç¡®ï¼‰ä¸ **Claude v2**ï¼ˆæ¶æ„åˆ†ææ·±å…¥ã€ä»£ç ç¤ºä¾‹è¯¦å°½ï¼‰çš„ä¼˜ç‚¹ï¼Œå½¢æˆ**æœ€ç»ˆå‚è€ƒç‰ˆæœ¬**ã€‚

**é˜…è¯»è·¯å¾„å»ºè®®**:

| è¯»è€…ç±»å‹ | æ¨èé˜…è¯»ç« èŠ‚ |
|----------|--------------|
| ğŸ†• æ–°äººäº†è§£é¡¹ç›® | [A. é¡¹ç›®æ¦‚è§ˆ](#a-é¡¹ç›®æ¦‚è§ˆ) â†’ [B. ä»£ç é˜…è¯»è·¯å¾„](#b-ä»£ç é˜…è¯»è·¯å¾„) |
| ğŸ” ç†è§£é—®é¢˜ | [C. æ ¸å¿ƒé—®é¢˜æ€»ç»“](#c-æ ¸å¿ƒé—®é¢˜æ€»ç»“) |
| ğŸ› ï¸ åŠ¨æ‰‹æ”¹è¿› | [D. ç›®æ ‡æ¶æ„](#d-ç›®æ ‡æ¶æ„) â†’ [E. æ”¹è¿›å®æ–½æŒ‡å—](#e-æ”¹è¿›å®æ–½æŒ‡å—) |
| ğŸ“‹ åˆ†é…ä»»åŠ¡ | [F. ä»»åŠ¡æ‹†è§£æ¸…å•](#f-ä»»åŠ¡æ‹†è§£æ¸…å•) |
| ğŸ“… è§„åˆ’è¿­ä»£ | [G. æ¼”è¿›è·¯çº¿å›¾](#g-æ¼”è¿›è·¯çº¿å›¾) |

---

## A. é¡¹ç›®æ¦‚è§ˆ

### A.1 è¿™æ˜¯ä»€ä¹ˆé¡¹ç›®ï¼Ÿ

**easyFactu** æ˜¯ä¸€ä¸ª**é¤é¥® POSï¼ˆæ”¶é“¶ï¼‰ç³»ç»Ÿ**ï¼Œæ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    easyFactu                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ½ï¸ æ¡Œå°ç®¡ç†    â”‚  ğŸ“ ç‚¹å•ä¸‹å•   â”‚  ğŸ’° ç»“è´¦/AA     â”‚
â”‚  ğŸ–¨ï¸ å°ç¥¨æ‰“å°    â”‚  ğŸ“Š æ—¥ç»“æŠ¥è¡¨   â”‚  ğŸ“± èœå•ç®¡ç†    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### A.2 æŠ€æœ¯æ ˆé€Ÿè§ˆ

| å±‚çº§ | æŠ€æœ¯é€‰æ‹© | è¯´æ˜ |
|------|----------|------|
| **å‰ç«¯æ¡†æ¶** | Next.js 16 (App Router) | React 19 + Turbopack |
| **çŠ¶æ€ç®¡ç†** | TanStack Query 5 | æ•°æ®è·å–å’Œç¼“å­˜ |
| **UI ç»„ä»¶** | shadcn/ui + TailwindCSS | Radix UI åŸºç¡€ |
| **åç«¯ API** | Next.js API Routes | å†…ç½®äº Next.js |
| **æ•°æ®åº“** | PostgreSQL (Supabase) | Drizzle ORM |
| **æµ‹è¯•** | Vitest + RTL + MSW | React Testing Library |

### A.3 ç›®å½•ç»“æ„ä¸€è§ˆ

```
easyFactu/
â”œâ”€â”€ app/                      # Next.js é¡µé¢å’Œ API
â”‚   â”œâ”€â”€ api/                  # åç«¯ API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ orders/           # è®¢å•ç›¸å…³ API
â”‚   â”‚   â”‚   â””â”€â”€ checkout/     # âš ï¸ ç»“è´¦é€»è¾‘ï¼ˆ742è¡Œï¼‰
â”‚   â”‚   â””â”€â”€ daily-closures/   # æ—¥ç»“ API
â”‚   â”œâ”€â”€ pos/                  # POS é¡µé¢
â”‚   â””â”€â”€ tables/               # æ¡Œå°é¡µé¢
â”‚
â”œâ”€â”€ components/               # UI ç»„ä»¶
â”‚   â”œâ”€â”€ features/             # âœ… åŠŸèƒ½æ¨¡å—ï¼ˆæ¨èï¼‰
â”‚   â”‚   â”œâ”€â”€ pos/              #    POS ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ tables/           #    æ¡Œå°ç›¸å…³ç»„ä»¶
â”‚   â”‚   â””â”€â”€ menu/             #    èœå•ç›¸å…³ç»„ä»¶
â”‚   â”œâ”€â”€ shared/               # è·¨æ¨¡å—å¤ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ ui/                   # âœ… åŸºç¡€ UI ç»„ä»¶ (shadcn/ui)
â”‚   â””â”€â”€ pos-interface.tsx     # âš ï¸ å¾…è¿ç§»åˆ° features/
â”‚
â”œâ”€â”€ hooks/                    # è‡ªå®šä¹‰ Hooks
â”‚   â”œâ”€â”€ useCheckout.ts        # ç»“è´¦çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ usePosOrder.ts        # POS è®¢å•çŠ¶æ€
â”‚
â”œâ”€â”€ lib/                      # æ ¸å¿ƒåº“
â”‚   â”œâ”€â”€ api/                  # âœ… API å®¢æˆ·ç«¯ï¼ˆç»Ÿä¸€è°ƒç”¨ï¼‰
â”‚   â”œâ”€â”€ queries/              # âœ… React Query Hooks
â”‚   â”œâ”€â”€ domain/               # ğŸ†• çº¯ä¸šåŠ¡è§„åˆ™ï¼ˆç›®æ ‡ä½ç½®ï¼‰
â”‚   â”œâ”€â”€ contracts/            # ğŸ†• Zod è¾“å…¥/è¾“å‡ºçº¦æŸï¼ˆç›®æ ‡ä½ç½®ï¼‰
â”‚   â”œâ”€â”€ serializers/          # ğŸ†• DB -> API DTO æ˜ å°„ï¼ˆç›®æ ‡ä½ç½®ï¼‰
â”‚   â”œâ”€â”€ money.ts              # âœ… é‡‘é¢è®¡ç®—å·¥å…·
â”‚   â””â”€â”€ order-utils.ts        # è®¢å•å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ services/                 # ğŸ†• ä¸šåŠ¡ç¼–æ’ä¸äº‹åŠ¡ï¼ˆç›®æ ‡ä½ç½®ï¼‰
â”œâ”€â”€ repositories/             # ğŸ†• DB è®¿é—®å°è£…ï¼ˆç›®æ ‡ä½ç½®ï¼‰
â”‚
â”œâ”€â”€ db/                       # æ•°æ®åº“
â”‚   â””â”€â”€ schema.ts             # Drizzle Schemaï¼ˆ13å¼ è¡¨ï¼‰
â”‚
â””â”€â”€ types/                    # ç±»å‹å®šä¹‰
    â””â”€â”€ api.ts                # API å¥‘çº¦ç±»å‹
```

> **å›¾ä¾‹**: âœ… = è®¾è®¡è‰¯å¥½ | âš ï¸ = éœ€è¦æ”¹è¿› | ğŸ†• = å¾…æ–°å¢

---

## B. ä»£ç é˜…è¯»è·¯å¾„

### B.1 ä¸€æ¡åŠŸèƒ½é“¾è·¯æ€ä¹ˆèµ°

1. ä» `app/*` æ‰¾é¡µé¢å…¥å£ï¼ˆä¾‹å¦‚ `app/pos/page.tsx`ï¼‰
2. è·³åˆ° `components/features/*` çš„åŠŸèƒ½ç»„ä»¶
3. æ•°æ®è¯·æ±‚ç»Ÿä¸€åœ¨ `lib/queries/*` â†’ `lib/api/*`
4. `app/api/*` åªåšæ ¡éªŒä¸è°ƒç”¨ `services/*`
5. æ ¸å¿ƒä¸šåŠ¡è§„åˆ™åœ¨ `lib/domain/*`ï¼ˆæˆ–å¾…è¿ç§»çš„ `lib/*`ï¼‰

### B.2 æ–°å¢åŠŸèƒ½æ”¾å“ªé‡Œ

| ç±»å‹ | è·¯å¾„ | ç¤ºä¾‹ |
|------|------|------|
| æ–°é¡µé¢ | `app/<feature>/page.tsx` | `app/reports/page.tsx` |
| æ–° UI ç»„ä»¶ | `components/features/<domain>/...` | `components/features/reports/ReportsView.tsx` |
| æ•°æ®è¯·æ±‚ | `lib/queries/<domain>` + `lib/api/<domain>` | `lib/queries/use-reports.ts` |
| ä¸šåŠ¡è§„åˆ™ | `lib/domain/<domain>` | `lib/domain/reports.ts` |
| API è·¯ç”± | `app/api/<domain>/route.ts` | `app/api/reports/route.ts`ï¼ˆåªåšæ ¡éªŒ + è°ƒ serviceï¼‰ |

### B.3 æ¨èé˜…è¯»é¡ºåºï¼ˆæ–°äººï¼‰

```
app/*  â†’  components/features/*  â†’  lib/queries/*  â†’  lib/api/*
                                                          â†“
                                              app/api/*  â†’  services/*
                                                          â†“
                                              repositories/*  â†’  db/schema.ts
```

1. **ç†è§£æ•°æ®æ¨¡å‹**: `db/schema.ts`
2. **ç†è§£ä¸šåŠ¡æµç¨‹**: `app/api/orders/checkout/route.ts`
3. **ç†è§£ UI ç»“æ„**: `components/features/pos/`

---

## C. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### C.1 é—®é¢˜æ¸…å•ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

| Pçº§ | é—®é¢˜ | å½±å“ | æ¶‰åŠæ–‡ä»¶ |
|-----|------|------|----------|
| **P0** | API è·¯ç”±æ‰¿è½½è¿‡å¤šä¸šåŠ¡é€»è¾‘ | éš¾æµ‹è¯•ã€éš¾å¤ç”¨ | `checkout/route.ts` (742è¡Œ) |
| **P0** | é‡å¤ç»„ä»¶å¹¶å­˜ | ç»´æŠ¤æ··ä¹± | `components/` vs `components/features/` |
| **P0** | API é”™è¯¯ç»“æ„ä¸ç»Ÿä¸€ | å‰ç«¯éš¾ä»¥å¤„ç† | æ‰€æœ‰ `app/api/*` |
| **P1** | ç»„ä»¶è¿‡å¤§ | éš¾ä»¥ç†è§£å’Œä¿®æ”¹ | `pos-interface.tsx` (623è¡Œ) |
| **P1** | éƒ¨åˆ†ç»„ä»¶ç»‘è¿‡ç»Ÿä¸€ API å±‚ | ç¼“å­˜ä¸ä¸€è‡´ | éƒ¨åˆ†ç»„ä»¶ç›´æ¥ `fetch` |
| **P2** | æµ‹è¯•è¦†ç›–ä¸è¶³ | é‡æ„æ— ä¿¡å¿ƒ | é¡¹ç›®èŒƒå›´ |
| **P2** | ç¯å¢ƒå˜é‡æ— ç±»å‹å®‰å…¨ | éƒ¨ç½²æ˜“å‡ºé”™ | `lib/db.ts` |

### C.2 é—®é¢˜è¯¦è§£

#### é—®é¢˜ 1: API è·¯ç”±æ‰¿è½½è¿‡å¤šä¸šåŠ¡é€»è¾‘ï¼ˆP0ï¼‰

```
           å½“å‰çŠ¶æ€                          ç›®æ ‡çŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   checkout/route.ts     â”‚          â”‚   checkout/route.ts     â”‚
â”‚   (742 è¡Œä»£ç )           â”‚    â†’     â”‚   (çº¦ 50 è¡Œ)             â”‚
â”‚                         â”‚          â”‚   - å‚æ•°æ ¡éªŒ             â”‚
â”‚   - å‚æ•°æ ¡éªŒ             â”‚          â”‚   - è°ƒç”¨ Service         â”‚
â”‚   - æ•°æ®åº“æŸ¥è¯¢           â”‚          â”‚   - è¿”å›å“åº”             â”‚
â”‚   - ä¸šåŠ¡è®¡ç®— (AA)        â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   - äº‹åŠ¡æ§åˆ¶             â”‚                      â”‚
â”‚   - HTTP å“åº”            â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   CheckoutService       â”‚
                                     â”‚   (ä¸šåŠ¡é€»è¾‘)             â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆè¿™æ˜¯é—®é¢˜ï¼Ÿ**
- âŒ éš¾ä»¥å•å…ƒæµ‹è¯•ï¼ˆéœ€è¦æ¨¡æ‹Ÿ HTTP è¯·æ±‚ï¼‰
- âŒ ç›¸ä¼¼é€»è¾‘éš¾ä»¥å¤ç”¨
- âŒ æ–°äººéš¾ä»¥ç†è§£ 742 è¡Œçš„å•ä¸ªæ–‡ä»¶

#### é—®é¢˜ 2: é‡å¤ç»„ä»¶å¹¶å­˜ï¼ˆP0ï¼‰

```
components/
â”œâ”€â”€ pos-interface.tsx          # ç‰ˆæœ¬ A
â”œâ”€â”€ PosMenuPane.tsx            # ç‰ˆæœ¬ A
â””â”€â”€ features/
    â””â”€â”€ pos/
        â”œâ”€â”€ PosInterface.tsx   # ç‰ˆæœ¬ B (æ–°ç‰ˆ)
        â””â”€â”€ PosMenuPane.tsx    # ç‰ˆæœ¬ B (æ–°ç‰ˆ)
```

**ä¸ºä»€ä¹ˆè¿™æ˜¯é—®é¢˜ï¼Ÿ**
- âŒ ä¸æ¸…æ¥šè¯¥ç”¨å“ªä¸ªç‰ˆæœ¬
- âŒ Bug ä¿®å¤å¯èƒ½åªæ”¹äº†ä¸€ä¸ªç‰ˆæœ¬
- âŒ æ–°äººå®¹æ˜“å¼•å…¥é”™è¯¯çš„ç‰ˆæœ¬

#### é—®é¢˜ 3: API é”™è¯¯ç»“æ„ä¸ç»Ÿä¸€ï¼ˆP0ï¼‰

```typescript
// å½“å‰ï¼šå„ API è¿”å›æ ¼å¼ä¸ä¸€è‡´
{ message: "é”™è¯¯" }      // æŸäº› API
{ error: "é”™è¯¯" }        // å¦ä¸€äº› API
{ success: false, ... }  // è¿˜æœ‰å…¶ä»–æ ¼å¼
```

---

## D. ç›®æ ‡æ¶æ„

### D.1 åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ“± è¡¨ç¤ºå±‚ (Presentation)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  app/* (é¡µé¢)    â”‚    components/* (UI ç»„ä»¶)                     â”‚  â”‚
â”‚  â”‚  - è·¯ç”±å¤„ç†       â”‚    - çº¯å±•ç¤ºç»„ä»¶                               â”‚  â”‚
â”‚  â”‚  - SSR/SSG       â”‚    - é€šè¿‡ Props æ¥æ”¶æ•°æ®                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ¯ åº”ç”¨å±‚ (Application)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  hooks/*          â”‚    lib/services/* (æˆ– services/*)           â”‚  â”‚
â”‚  â”‚  - UI çŠ¶æ€ç®¡ç†     â”‚    - ä¸šåŠ¡é€»è¾‘ç¼–æ’                            â”‚  â”‚
â”‚  â”‚  - æ•°æ®è·å– Hooks  â”‚    - äº‹åŠ¡æ§åˆ¶                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ’¼ é¢†åŸŸå±‚ (Domain) [æ–°å¢]                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  lib/domain/*                                                   â”‚  â”‚
â”‚  â”‚  - Money.ts (é‡‘é¢å€¼å¯¹è±¡)                                         â”‚  â”‚
â”‚  â”‚  - Order.ts (è®¢å•å®ä½“)                                           â”‚  â”‚
â”‚  â”‚  - Checkout.ts (ç»“è´¦é¢†åŸŸé€»è¾‘)                                     â”‚  â”‚
â”‚  â”‚  - çº¯ä¸šåŠ¡è§„åˆ™ï¼Œä¸ä¾èµ–æ•°æ®åº“                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ—„ï¸ åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  app/api/*        â”‚    repositories/*          â”‚    db/*       â”‚  â”‚
â”‚  â”‚  - HTTP å¤„ç†      â”‚    - æ•°æ®è®¿é—®æŠ½è±¡            â”‚    - Schema   â”‚  â”‚
â”‚  â”‚  - å‚æ•°æ ¡éªŒ       â”‚    - å°è£… Drizzle è°ƒç”¨       â”‚    - è¿ç§»     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### D.2 ä¾èµ–è§„åˆ™

```
                    âœ… å…è®¸ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡¨ç¤ºå±‚ â†’ åº”ç”¨å±‚ â†’ é¢†åŸŸå±‚ â† åŸºç¡€è®¾æ–½å±‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    âŒ ç¦æ­¢ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡¨ç¤ºå±‚ âœ— ç›´æ¥è®¿é—®æ•°æ®åº“              â”‚
â”‚  é¢†åŸŸå±‚ âœ— ä¾èµ–ä»»ä½•å¤–éƒ¨å±‚              â”‚
â”‚  åº”ç”¨å±‚ âœ— ä¾èµ–è¡¨ç¤ºå±‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### D.3 ç›®å½•ç»“æ„ç›®æ ‡

```
lib/
â”œâ”€â”€ api/              # âœ… ä¿æŒ - API å®¢æˆ·ç«¯
â”œâ”€â”€ queries/          # âœ… ä¿æŒ - React Query Hooks
â”œâ”€â”€ constants/        # âœ… ä¿æŒ - å¸¸é‡å®šä¹‰
â”œâ”€â”€ domain/           # ğŸ†• æ–°å¢ - é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ Money.ts      #    é‡‘é¢å€¼å¯¹è±¡
â”‚   â”œâ”€â”€ Order.ts      #    è®¢å•å®ä½“
â”‚   â””â”€â”€ Checkout.ts   #    ç»“è´¦é¢†åŸŸé€»è¾‘
â”œâ”€â”€ contracts/        # ğŸ†• æ–°å¢ - Zod è¾“å…¥/è¾“å‡ºçº¦æŸ
â”œâ”€â”€ serializers/      # ğŸ†• æ–°å¢ - DB -> API DTO æ˜ å°„
â””â”€â”€ http/             # ğŸ†• æ–°å¢ - HTTP å·¥å…·
    â””â”€â”€ response.ts   #    ç»Ÿä¸€å“åº”å‡½æ•°

services/             # ğŸ†• æ–°å¢ - ä¸šåŠ¡æœåŠ¡å±‚
â”œâ”€â”€ index.ts          #    å¯¼å‡ºå…¥å£
â”œâ”€â”€ orders/
â”‚   â”œâ”€â”€ checkout.ts
â”‚   â”œâ”€â”€ create.ts
â”‚   â””â”€â”€ transfer.ts
â””â”€â”€ daily-closures/
    â””â”€â”€ confirm.ts

repositories/         # ğŸ†• æ–°å¢ - æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ index.ts          #    å¯¼å‡ºå…¥å£
â”œâ”€â”€ orders.ts
â””â”€â”€ transactions.ts
```

---

## E. æ”¹è¿›å®æ–½æŒ‡å—

### E.1 ç¬¬ä¸€æ­¥ï¼šç»Ÿä¸€ API å“åº”ä¸é”™è¯¯ç»“æ„ï¼ˆ1å°æ—¶ï¼‰

åˆ›å»ºç»Ÿä¸€çš„ HTTP å“åº”å·¥å…·ï¼š

```typescript
// lib/http/response.ts

import { NextResponse } from "next/server"
import { ZodError } from "zod"

// æˆåŠŸå“åº”
export function jsonOk<T>(data: T, status = 200) {
  return NextResponse.json(data, { status })
}

// é”™è¯¯å“åº”
export function jsonError(
  status: number,
  code: string,
  error: string,
  detail?: unknown
) {
  return NextResponse.json({ error, code, detail }, { status })
}

// ç»Ÿä¸€é”™è¯¯å¤„ç†åŒ…è£…å™¨
export async function withHandler<T>(
  handler: () => Promise<T>
): Promise<NextResponse> {
  try {
    const result = await handler()
    return jsonOk(result)
  } catch (err) {
    // Zod æ ¡éªŒé”™è¯¯
    if (err instanceof ZodError) {
      return jsonError(400, "VALIDATION_ERROR", "å‚æ•°æ ¡éªŒå¤±è´¥", err.flatten())
    }
    
    // æ•°æ®åº“å”¯ä¸€çº¦æŸé”™è¯¯
    if ((err as { code?: string }).code === "23505") {
      return jsonError(409, "DUPLICATE_ENTRY", "æ•°æ®å·²å­˜åœ¨")
    }
    
    // å…¶ä»–é”™è¯¯
    console.error("[API Error]", err)
    return jsonError(500, "INTERNAL_ERROR", "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯")
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```typescript
// app/api/orders/route.ts (æ”¹è¿›å)

import { withHandler, jsonOk } from "@/lib/http/response"

export async function GET() {
  return withHandler(async () => {
    const orders = await db.select().from(ordersTable)
    return orders
  })
}
```

### E.2 ç¬¬äºŒæ­¥ï¼šç¯å¢ƒå˜é‡ç±»å‹å®‰å…¨åŒ–ï¼ˆ30åˆ†é’Ÿï¼‰

```typescript
// lib/env.ts

import { z } from "zod"

const envSchema = z.object({
  DATABASE_URL: z.string().url("DATABASE_URL å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL"),
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
})

// å¯åŠ¨æ—¶æ ¡éªŒç¯å¢ƒå˜é‡
export const env = envSchema.parse({
  DATABASE_URL: process.env.DATABASE_URL,
  NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
  NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY,
})
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```typescript
// lib/db.ts (æ”¹è¿›å)

import { env } from "@/lib/env"

const db = drizzle(env.DATABASE_URL)  // ç±»å‹å®‰å…¨ï¼
```

### E.3 ç¬¬ä¸‰æ­¥ï¼šç»Ÿä¸€ç»„ä»¶å¯¼å…¥è·¯å¾„ï¼ˆ2å°æ—¶ï¼‰

å¯¹äºé‡å¤çš„ç»„ä»¶ï¼Œå°†æ—§è·¯å¾„æ”¹ä¸º re-exportï¼š

```typescript
// components/pos-interface.tsx (æ”¹ä¸º re-export)

// æ—§ä»£ç å…¨éƒ¨åˆ é™¤ï¼Œåªä¿ç•™ä¸€è¡Œ
export { PosInterface } from "@/components/features/pos/PosInterface"
```

æˆ–è€…ç§»åŠ¨åˆ° `legacy/` ç›®å½•å¹¶æ·»åŠ åºŸå¼ƒè­¦å‘Šï¼š

```typescript
// components/legacy/pos-interface.tsx

/**
 * @deprecated è¯·ä½¿ç”¨ @/components/features/pos/PosInterface
 */
export { default } from "@/components/features/pos/PosInterface"
```

### E.4 ç¬¬å››æ­¥ï¼šæŠ½å– Service å±‚ï¼ˆ1å¤©ï¼‰

ä»¥ç»“è´¦é€»è¾‘ä¸ºä¾‹ï¼š

```typescript
// services/orders/checkout.ts

import { db, Transaction } from "@/lib/db"
import { calculateCheckoutTotal } from "@/lib/domain/Checkout"

export interface CheckoutInput {
  orderId: number
  paymentMode: "full" | "aa"
  paymentMethod: "cash" | "card"
  items?: { id: number; amount: number }[]
}

export interface CheckoutResult {
  success: boolean
  transactionId: number
  totalPaid: number
}

export async function processCheckout(
  input: CheckoutInput
): Promise<CheckoutResult> {
  return await db.transaction(async (tx: Transaction) => {
    // 1. è·å–è®¢å•
    const order = await getOrderById(input.orderId, tx)
    
    // 2. éªŒè¯è®¢å•çŠ¶æ€
    if (order.status === "paid") {
      throw new Error("è®¢å•å·²ç»“è´¦")
    }
    
    // 3. è®¡ç®—é‡‘é¢ï¼ˆä½¿ç”¨é¢†åŸŸå‡½æ•°ï¼‰
    const calculation = calculateCheckoutTotal(order, input)
    
    // 4. æ›´æ–°è®¢å•çŠ¶æ€
    await updateOrderStatus(input.orderId, "paid", tx)
    
    // 5. åˆ›å»ºäº¤æ˜“è®°å½•
    const transactionId = await createTransaction(calculation, tx)
    
    return {
      success: true,
      transactionId,
      totalPaid: calculation.total,
    }
  })
}
```

**API è·¯ç”±ç®€åŒ–**ï¼š

```typescript
// app/api/orders/checkout/route.ts (æ”¹è¿›åï¼šçº¦50è¡Œ)

import { NextRequest } from "next/server"
import { z } from "zod"
import { withHandler } from "@/lib/http/response"
import { processCheckout } from "@/services/orders/checkout"

const checkoutSchema = z.object({
  orderId: z.number(),
  paymentMode: z.enum(["full", "aa"]),
  paymentMethod: z.enum(["cash", "card"]),
  items: z.array(z.object({
    id: z.number(),
    amount: z.number(),
  })).optional(),
})

export async function POST(req: NextRequest) {
  return withHandler(async () => {
    const body = await req.json()
    const input = checkoutSchema.parse(body)
    return processCheckout(input)
  })
}
```

---

## F. ä»»åŠ¡æ‹†è§£æ¸…å•

> **è¯´æ˜**: æ¯æ¡ä»»åŠ¡åŒ…å«èŒƒå›´ã€æ­¥éª¤ã€éªŒæ”¶æ ‡å‡†ï¼Œä¾¿äºæ‹†åˆ†å¹¶è¡Œæ¨è¿›ã€‚

### F.1 åŸºç¡€å·¥ç¨‹ï¼ˆBASEï¼‰

#### BASE-01 (P0) å»ºç«‹ services/repositories éª¨æ¶
**èŒƒå›´**: `services/`, `repositories/`, `services/index.ts`, `repositories/index.ts`  
**æ­¥éª¤**:
1. æ–°å»ºç›®å½•ä¸å¯¼å‡ºå…¥å£
2. å…ˆä¸åŠ¨ä¸šåŠ¡é€»è¾‘ï¼Œä»…æä¾›ç»“æ„

**éªŒæ”¶**: ç›®å½•å­˜åœ¨ä¸”å¯è¢« importï¼Œæ—  lint æŠ¥é”™

#### BASE-02 (P0) ç»Ÿä¸€ API å“åº”ä¸é”™è¯¯ç»“æ„
**èŒƒå›´**: `lib/http/response.ts`, `app/api/*`  
**æ­¥éª¤**:
1. æ–°å¢ `jsonOk/jsonError` helper
2. æ–°å¢ `withHandler`ï¼Œç»Ÿä¸€ Zod/DB é”™è¯¯æ˜ å°„
3. å…ˆè½åœ°åˆ° `app/api/restaurant-tables/route.ts`ã€`app/api/orders/checkout/route.ts`ï¼Œå†æ¨å¹¿å…¨é‡

**éªŒæ”¶**: å…¨å±€ä¸å†å‡ºç° `{ message }` / `{ error }` æ··ç”¨

#### BASE-03 (P1) ç¯å¢ƒå˜é‡ç±»å‹å®‰å…¨åŒ–
**èŒƒå›´**: `lib/env.ts`, `lib/db.ts`, `lib/supabase/*`  
**æ­¥éª¤**:
1. ç”¨ zod æ ¡éªŒå…³é”® env
2. æ‰€æœ‰ env é€šè¿‡ `lib/env.ts` è·å–

**éªŒæ”¶**: å¯åŠ¨ç¼ºå°‘ env æ—¶å¯è¯»é”™è¯¯

#### BASE-04 (P1) DTO åºåˆ—åŒ–é›†ä¸­ç®¡ç†
**èŒƒå›´**: `lib/serializers/*`, `app/api/menu-items/*`, `app/api/orders/*`  
**æ­¥éª¤**:
1. æ–°å»º `lib/serializers/menu.ts`ã€`lib/serializers/orders.ts`
2. API route ä½¿ç”¨ serializer è¿”å›æ•°æ®

**éªŒæ”¶**: DB -> API æ˜ å°„ä»…åœ¨ serializers ä¸­å‡ºç°

---

### F.2 ç»„ä»¶/Hook å»é‡ï¼ˆSSOTï¼‰

#### SSOT-01 (P0) POS ç»„ä»¶å»é‡
**èŒƒå›´**: `components/pos-interface.tsx`, `components/PosCheckoutDialog.tsx`, `components/PosMenuPane.tsx`, `components/PosOrderSidebar.tsx`, `components/PosReceiptPreview.tsx`  
**æ­¥éª¤**:
1. ç»Ÿä¸€ä¿ç•™ `components/features/pos/*` ä¸ºå”¯ä¸€å®ç°
2. æ—§è·¯å¾„æ”¹ä¸º re-export æˆ–ç§»è‡³ `components/legacy/`

**éªŒæ”¶**: POS ç»„ä»¶æ— é‡å¤å®ç°ï¼Œå¯¼å…¥è·¯å¾„ç»Ÿä¸€

#### SSOT-02 (P0) Tables ç»„ä»¶å»é‡
**èŒƒå›´**: `components/table-management.tsx`, `components/TableTransferDialogs.tsx`  
**æ­¥éª¤**:
1. ç»Ÿä¸€ä¿ç•™ `components/features/tables/*`
2. æ—§è·¯å¾„ re-export

**éªŒæ”¶**: Tables ç»„ä»¶æ— é‡å¤å®ç°

#### SSOT-03 (P0) Menu ç»„ä»¶å»é‡
**èŒƒå›´**: `components/menu-management.tsx`  
**æ­¥éª¤**:
1. ç»Ÿä¸€ä¿ç•™ `components/features/menu/MenuManagement.tsx`
2. æ—§è·¯å¾„ re-export

**éªŒæ”¶**: Menu ç»„ä»¶æ— é‡å¤å®ç°

#### SSOT-04 (P0) use-toast ç»Ÿä¸€
**èŒƒå›´**: `hooks/use-toast.ts`, `components/ui/use-toast.ts`  
**æ­¥éª¤**:
1. å†³å®šå•ä¸€æ¥æºï¼ˆå»ºè®® `components/ui/use-toast.ts`ï¼‰
2. å…¶å®ƒè·¯å¾„ re-export

**éªŒæ”¶**: å…¨é¡¹ç›®åªå­˜åœ¨ä¸€ä¸ªå®ç°æ¥æº

---

### F.3 POS + Ordersï¼ˆPOS/ORDï¼‰

#### POS-01 (P0) POS ç»“è´¦ä½¿ç”¨ query/mutation
**èŒƒå›´**: `components/features/pos/PosInterface.tsx`, `components/pos-interface.tsx`  
**æ­¥éª¤**:
1. ç”¨ `lib/queries/use-orders.ts` çš„ `useCheckout` æ›¿æ¢ `fetch`
2. ç»Ÿä¸€é”™è¯¯æç¤ºä¸ loading çŠ¶æ€

**éªŒæ”¶**: UI ä¸å†ç›´æ¥ `fetch` ç»“è´¦æ¥å£

#### POS-02 (P1) æ‹†åˆ† PosInterface
**èŒƒå›´**: `components/features/pos/PosInterface.tsx`  
**æ­¥éª¤**:
1. æŠ½å‡º `PosHeader`ã€`PosContent`ã€`PosFooter`ï¼ˆæˆ–ç­‰ä»·åˆ’åˆ†ï¼‰
2. å­ç»„ä»¶åªé€šè¿‡ props ä¼ é€’çŠ¶æ€

**éªŒæ”¶**: `PosInterface.tsx` è¡Œæ•° < 300

#### ORD-01 (P0) Checkout Service æŠ½ç¦»
**èŒƒå›´**: `app/api/orders/checkout/route.ts`, `services/orders/checkout.ts`, `repositories/orders.ts`, `repositories/transactions.ts`  
**æ­¥éª¤**:
1. æŠŠäº‹åŠ¡ä¸ä¸šåŠ¡è§„åˆ™è¿åˆ° service
2. route ä»…æ ¡éªŒä¸è°ƒç”¨

**éªŒæ”¶**: route é‡Œåªå‰©æ ¡éªŒ + service è°ƒç”¨

#### ORD-02 (P0) Order Create Service æŠ½ç¦»
**èŒƒå›´**: `app/api/orders/route.ts`, `services/orders/create.ts`, `repositories/orders.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### ORD-03 (P0) Order Item Update Service æŠ½ç¦»
**èŒƒå›´**: `app/api/orders/[id]/route.ts`, `services/orders/update-item.ts`, `repositories/order-items.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### ORD-04 (P0) Order Transfer/Clear Service æŠ½ç¦»
**èŒƒå›´**: `app/api/orders/transfer/route.ts`, `app/api/orders/clear/route.ts`, `services/orders/transfer.ts`, `services/orders/clear.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### ORD-05 (P1) ç»“è´¦/AA è®¡ç®—ç»Ÿä¸€åˆ° domain
**èŒƒå›´**: `lib/checkout/calculate.ts`, `hooks/useCheckout.ts`, `lib/domain/checkout.ts`ï¼ˆæ–°ï¼‰  
**æ­¥éª¤**:
1. ä»¥ `lib/checkout/calculate.ts` ä¸ºæ ¸å¿ƒï¼Œå»ºç«‹ `lib/domain/checkout.ts` å…¥å£
2. `hooks/useCheckout.ts` ä»…è´Ÿè´£ UI çŠ¶æ€ç®¡ç†

**éªŒæ”¶**: ä¸šåŠ¡è®¡ç®—åªåœ¨ domain å±‚

---

### F.4 Tablesï¼ˆTBLï¼‰

#### TBL-01 (P0) TableManagement ä½¿ç”¨ queries
**èŒƒå›´**: `components/features/tables/TableManagement.tsx`, `components/table-management.tsx`  
**æ­¥éª¤**:
1. ä½¿ç”¨ `useCreateTable`ã€`useDeleteTable` æ›¿æ¢ `fetch`
2. UI åªå¤„ç†è¡¨å•ä¸ toast

**éªŒæ”¶**: Table ç®¡ç†ä¸å†ç›´æ¥ `fetch`

#### TBL-02 (P0) TableTransferDialogs ä½¿ç”¨ query/mutation
**èŒƒå›´**: `components/features/tables/TableTransferDialogs.tsx`, `components/TableTransferDialogs.tsx`  
**æ­¥éª¤**:
1. ä½¿ç”¨ `useTableOrderQuery` è·å–è®¢å•
2. ä½¿ç”¨ `useTransferOrder` è¿›è¡Œæ‹†å¹¶å°

**éªŒæ”¶**: UI ä¸å†ç›´æ¥ `fetch` è®¢å•/æ‹†å¹¶å°

#### TBL-03 (P1) useTableTransfer ä½¿ç”¨ api client
**èŒƒå›´**: `hooks/useTableTransfer.ts`  
**æ­¥éª¤**:
1. ç”¨ `api.orders.transfer` æˆ– `useTransferOrder` æ›¿æ¢ `fetch`

**éªŒæ”¶**: hook ä¸ç›´æ¥ `fetch`

#### TBL-04 (P1) Table API Service æŠ½ç¦»
**èŒƒå›´**: `app/api/restaurant-tables/route.ts`, `app/api/restaurant-tables/[id]/route.ts`, `services/tables/*`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

---

### F.5 Menuï¼ˆMENUï¼‰

#### MENU-01 (P0) MenuManagement ä½¿ç”¨ queries
**èŒƒå›´**: `components/features/menu/MenuManagement.tsx`, `components/menu-management.tsx`  
**æ­¥éª¤**:
1. ä½¿ç”¨ `useMenuQuery`ã€`useCreateMenuItem`ã€`useUpdateMenuItem`ã€`useDeleteMenuItem`

**éªŒæ”¶**: UI ä¸å†ç›´æ¥ `fetch`

#### MENU-02 (P1) Menu API Service æŠ½ç¦»
**èŒƒå›´**: `app/api/menu-items/route.ts`, `app/api/menu-items/[id]/route.ts`, `app/api/menu-items/[id]/restore/route.ts`, `services/menu/*`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### MENU-03 (P1) Menu DTO åºåˆ—åŒ–
**èŒƒå›´**: `lib/serializers/menu.ts`, `app/api/menu-items/*`

**éªŒæ”¶**: åºåˆ—åŒ–é€»è¾‘ä¸å‡ºç°åœ¨ route

---

### F.6 Financeï¼ˆFINï¼‰

#### FIN-01 (P0) Daily Closure Service æŠ½ç¦»
**èŒƒå›´**: `app/api/daily-closure/route.ts`, `services/daily-closure/get-current.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### FIN-02 (P0) Daily Closure Confirm Service æŠ½ç¦»
**èŒƒå›´**: `app/api/daily-closures/confirm/route.ts`, `services/daily-closures/confirm.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### FIN-03 (P1) Daily Closure Adjustments Service æŠ½ç¦»
**èŒƒå›´**: `app/api/daily-closures/[id]/adjustments/route.ts`, `services/daily-closures/adjustments.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### FIN-04 (P1) Daily Closure Export Service æŠ½ç¦»
**èŒƒå›´**: `app/api/daily-closures/[id]/export/route.ts`, `services/daily-closures/export.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### FIN-05 (P1) Reports Service æŠ½ç¦»
**èŒƒå›´**: `app/api/reports/route.ts`, `services/reports/get.ts`, `lib/reports/*`

**éªŒæ”¶**: èšåˆé€»è¾‘ä¸åœ¨ route

#### FIN-06 (P1) Reports Export Service æŠ½ç¦»
**èŒƒå›´**: `app/api/reports/export/route.ts`, `services/reports/export.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### FIN-07 (P1) Transactions Service æŠ½ç¦»
**èŒƒå›´**: `app/api/transactions/[id]/route.ts`, `app/api/transactions/[id]/reverse/route.ts`, `services/transactions/*`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### FIN-08 (P1) Checkout History Service æŠ½ç¦»
**èŒƒå›´**: `app/api/checkout-history/route.ts`, `services/checkout-history/get.ts`

**éªŒæ”¶**: route æ— ä¸šåŠ¡é€»è¾‘

#### FIN-09 (P0) Reports UI ä½¿ç”¨ query
**èŒƒå›´**: `components/reports-view.tsx`, `lib/queries/use-reports.ts`

**éªŒæ”¶**: UI ä¸å†ç›´æ¥ `fetch` æŠ¥è¡¨

---

### F.7 Settingsï¼ˆSETï¼‰

#### SET-01 (P1) Restaurant Settings å¼•å…¥ api + query
**èŒƒå›´**: `lib/api/client.ts`, `lib/queries/use-restaurant-settings.ts`, `components/settings-view.tsx`  
**æ­¥éª¤**:
1. å¢åŠ  `api.restaurantSettings.get/update`
2. æ–°å¢ query/mutation
3. ç»„ä»¶ç”¨ hooks è°ƒç”¨

**éªŒæ”¶**: settings UI ä¸å†ç›´æ¥ `fetch`

---

### F.8 Tests & CIï¼ˆTESTï¼‰

#### TEST-01 (P0) æ ¸å¿ƒå·¥å…·å‡½æ•°å•æµ‹
**èŒƒå›´**: `lib/money.ts`, `lib/order-utils.ts`

**éªŒæ”¶**: è¦†ç›–ç‡è¾¾æ ‡ï¼ˆ>60%ï¼‰

#### TEST-02 (P0) ç»“è´¦è®¡ç®—å•æµ‹
**èŒƒå›´**: `lib/checkout/calculate.ts`

**éªŒæ”¶**: æ ¸å¿ƒåˆ†æ”¯è¦†ç›–

#### TEST-03 (P1) Checkout Service é›†æˆæµ‹è¯•
**èŒƒå›´**: `services/orders/checkout.ts`, `app/api/orders/checkout/route.ts`

**éªŒæ”¶**: ä¸»æµç¨‹é€šè¿‡ã€é”™è¯¯è·¯å¾„è¦†ç›–

#### TEST-04 (P1) Reports/Daily Closure å•æµ‹
**èŒƒå›´**: `lib/reports/*`, `lib/daily-closure/*`

**éªŒæ”¶**: èšåˆé€»è¾‘è¦†ç›–

---

## G. æ¼”è¿›è·¯çº¿å›¾

### G.1 æ”¹é€ é¡ºåºå»ºè®®ï¼ˆå¹¶è¡Œå‹å¥½ï¼‰

```
é˜¶æ®µ 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ åŸºç¡€ä¸å»é‡ï¼šBASE-01/02 + SSOT-01~04                        â”‚
â”‚ å·¥ä½œé‡ï¼š1-2 å¤© | é£é™©ï¼šä½                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        â†“
        
é˜¶æ®µ 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ æ•°æ®è·å–ç»Ÿä¸€ï¼šPOS-01ã€TBL-01/02ã€MENU-01ã€FIN-09            â”‚
â”‚ å·¥ä½œé‡ï¼š2-3 å¤© | é£é™©ï¼šä½                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        â†“
        
é˜¶æ®µ 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ æœåŠ¡å±‚æŠ½ç¦»ï¼šORD-01~04 â†’ FIN-01~08 â†’ MENU-02 â†’ TBL-04       â”‚
â”‚ å·¥ä½œé‡ï¼š1-2 å‘¨ | é£é™©ï¼šä¸­                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        â†“
        
é˜¶æ®µ 4 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ é¢†åŸŸåŒ–ä¸æµ‹è¯•ï¼šORD-05 + TEST-01~04                          â”‚
â”‚ å·¥ä½œé‡ï¼š1-2 å‘¨ | é£é™©ï¼šä½                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### G.2 è¯¦ç»†æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | é£é™© | æ”¶ç›Š |
|------|------|--------|------|------|
| **é˜¶æ®µ 1** | åˆ›å»º `lib/http/response.ts` | S | ä½ | ç»Ÿä¸€é”™è¯¯å¤„ç† |
| | åˆ›å»º `lib/env.ts` | S | ä½ | å¯åŠ¨æ—¶å‘ç°é…ç½®é”™è¯¯ |
| | ç»Ÿä¸€ç»„ä»¶å¯¼å…¥ï¼ˆre-exportï¼‰ | M | ä½ | æ¶ˆé™¤æ··æ·† |
| | ä¸º `lib/money.ts` è¡¥å……æµ‹è¯• | S | æ—  | æ ¸å¿ƒé€»è¾‘ä¿éšœ |
| **é˜¶æ®µ 2** | ç»„ä»¶ä½¿ç”¨ React Query | M | ä½ | ç¼“å­˜ä¸€è‡´æ€§ |
| **é˜¶æ®µ 3** | åˆ›å»º `CheckoutService` | L | ä¸­ | å¯æµ‹è¯•æ€§æå‡ |
| | æ‹†åˆ† `pos-interface.tsx` | M | ä¸­ | å¯ç»´æŠ¤æ€§æå‡ |
| **é˜¶æ®µ 4** | åˆ›å»º `lib/domain/Money.ts` | S | ä½ | é‡‘é¢è®¡ç®—ç»Ÿä¸€ |
| | è¡¥å…… API é›†æˆæµ‹è¯• | M | æ—  | é‡æ„å®‰å…¨ç½‘ |

---

## H. å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ Service å±‚ï¼Ÿç›´æ¥åœ¨ API è·¯ç”±å†™ä¸è¡Œå—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†ä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š
- ğŸ“ **æµ‹è¯•å›°éš¾**: éœ€è¦æ¨¡æ‹Ÿæ•´ä¸ª HTTP è¯·æ±‚æ‰èƒ½æµ‹è¯•ä¸šåŠ¡é€»è¾‘
- ğŸ“ **å¤ç”¨å›°éš¾**: å¦‚æœå¦ä¸€ä¸ª API éœ€è¦ç›¸åŒé€»è¾‘ï¼Œåªèƒ½å¤åˆ¶ä»£ç 
- ğŸ“ **ä»£ç è†¨èƒ€**: API è·¯ç”±ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œéš¾ä»¥é˜…è¯»

### Q2: Domain å±‚å’Œ Service å±‚æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**: 
| å±‚çº§ | èŒè´£ | ç¤ºä¾‹ |
|------|------|------|
| **Domain** | çº¯ä¸šåŠ¡è§„åˆ™ï¼Œä¸æ¶‰åŠæ•°æ®åº“ | `calculateTax(amount)` |
| **Service** | ä¸šåŠ¡ç¼–æ’ï¼Œè°ƒç”¨å¤šä¸ªæ“ä½œ | `processCheckout()` (æŸ¥è¯¢+è®¡ç®—+ä¿å­˜) |

### Q3: é‡æ„ä¸€å®šè¦ä¸€æ¬¡å®Œæˆå—ï¼Ÿ

**A**: ä¸éœ€è¦ï¼å»ºè®®é‡‡ç”¨**æ¸è¿›å¼é‡æ„**ï¼š
1. æ–°åŠŸèƒ½ç”¨æ–°æ¶æ„å†™
2. ä¿®æ”¹æ—§ä»£ç æ—¶é¡ºä¾¿é‡æ„
3. ä¿æŒä¸¤å¥—ä»£ç å…±å­˜ï¼Œé€æ­¥è¿ç§»

### Q4: ä¼˜å…ˆçº§ P0/P1/P2 æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

**A**:
| ä¼˜å…ˆçº§ | å«ä¹‰ | å»ºè®®æ—¶é—´ |
|--------|------|----------|
| **P0** | é˜»å¡å¼€å‘æ•ˆç‡ï¼Œå¿…é¡»ç«‹å³è§£å†³ | æœ¬å‘¨ |
| **P1** | å½±å“ä»£ç è´¨é‡ï¼Œåº”å°½å¿«è§£å†³ | æœ¬æœˆ |
| **P2** | æ”¹å–„é•¿æœŸå¥åº·åº¦ï¼Œå¯ä»¥è§„åˆ’ | å­£åº¦å†… |

---

## I. é™„å½•

### I.1 å…³é”®æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | è¡Œæ•° | çŠ¶æ€ | æ”¹è¿›æ–¹å‘ |
|------|------|------|----------|
| [checkout/route.ts](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/app/api/orders/checkout/route.ts) | 742 | âš ï¸ | æŠ½å–åˆ° Service |
| [pos-interface.tsx](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/components/pos-interface.tsx) | 623 | âš ï¸ | æ‹†åˆ†å­ç»„ä»¶ |
| [menu-management.tsx](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/components/menu-management.tsx) | 621 | âš ï¸ | æ‹†åˆ†å­ç»„ä»¶ |
| [useCheckout.ts](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/hooks/useCheckout.ts) | 359 | âš ï¸ | éœ€è¡¥å……æµ‹è¯• |
| [money.ts](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/lib/money.ts) | - | âœ… | éœ€è¡¥å……æµ‹è¯• |
| [db/schema.ts](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/db/schema.ts) | 349 | âœ… | è‰¯å¥½ |

### I.2 å¯éªŒæ”¶å®Œæˆæ ‡å‡†

- âœ… æ–°äººå¯æŒ‰é˜…è¯»æŒ‡å—å®Œæ•´è¿½è¸ª POS/æ¡Œå°/èœå•çš„æ•°æ®æµ
- âœ… UI ä¸­ä¸å­˜åœ¨ç›´æ¥ `fetch` è¯·æ±‚
- âœ… ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨ `services/*` ä¸ `lib/domain/*`
- âœ… åŒåç»„ä»¶/Hook åªæœ‰ä¸€ä¸ªå®ç°æ¥æº
- âœ… æ ¸å¿ƒä¸šåŠ¡è®¡ç®—å…·å¤‡å•æµ‹è¦†ç›–

### I.3 ç›¸å…³æ–‡æ¡£

- [Codex v2 è¯„å®¡](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/doc/architecture_review_codex_v2.md)
- [Claude v2 è¯„å®¡](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/doc/architecture_review_claude_v2.md)
- [åŸå§‹è¯„å®¡-Codexç‰ˆ](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/doc/architecture_review_codex.md)
- [åŸå§‹è¯„å®¡-Claudeç‰ˆ](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/doc/architecture_review_claude.md)
- [åŸå§‹è¯„å®¡-Geminiç‰ˆ](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/doc/architecture_review_gemini.md)

---

> ğŸ“ æœ¬æ–‡æ¡£åŸºäº 2025-12-26 ä»£ç åº“å¿«ç…§ç”Ÿæˆï¼Œç»¼åˆäº† Codex v2 çš„ä»»åŠ¡æ‹†è§£ä¸ Claude v2 çš„æ¶æ„åˆ†æä¼˜ç‚¹ï¼Œå»ºè®®éšé¡¹ç›®æ¼”è¿›æŒç»­æ›´æ–°ã€‚
