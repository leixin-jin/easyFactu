# easyFactu ä»£ç åº“æ¶æ„è¯„å®¡

> èµ„æ·±è½¯ä»¶æ¶æ„å¸ˆ + ä»£ç å®¡æŸ¥ä¸“å®¶è§†è§’

---

## ğŸ“Œ A. å¿«é€Ÿç»“è®º (TL;DR)

åŸºäºå¯¹ä»£ç åº“çš„æ·±å…¥åˆ†æï¼Œä»¥ä¸‹æ˜¯ **æŒ‰æ”¶ç›Šæ’åºçš„ 7 æ¡æœ€å…³é”®æ”¹è¿›ç‚¹**ï¼š

| # | æ”¹è¿›ç‚¹ | é¢„è®¡æ”¶ç›Š |
|---|--------|---------|
| 1 | **æ‹†åˆ†è¶…å¤§ç»„ä»¶ï¼ˆpos-interface.tsx 623è¡Œ, menu-management.tsx 621è¡Œï¼‰** | ç»´æŠ¤æˆæœ¬â†“40%ï¼Œå¯æµ‹è¯•æ€§å¤§å¹…æå‡ |
| 2 | **æŠ½å–ä¸šåŠ¡é€»è¾‘è‡³ Service å±‚ï¼ˆcheckout/route.ts 742è¡Œï¼‰** | ä»£ç å¤ç”¨â†‘ï¼Œæµ‹è¯•è¦†ç›–ç‡å¯è¾¾80%+ |
| 3 | **ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸æ—¥å¿—è®°å½•** | é—®é¢˜å®šä½é€Ÿåº¦â†‘300%ï¼Œé£é™©é™ä½ |
| 4 | **å»ºç«‹é¢†åŸŸæ¨¡å‹å±‚ï¼ˆDomain Layerï¼‰** | ä¸šåŠ¡æ¦‚å¿µæ¸…æ™°åŒ–ï¼Œæ‰©å±•é€Ÿåº¦â†‘50% |
| 5 | **é‡æ„ API è·¯ç”±ä½¿ç”¨æ ‡å‡†åŒ–ä¸­é—´ä»¶æ¨¡å¼** | ä»£ç å¤ç”¨â†‘ï¼Œå®‰å…¨æ€§å¢å¼º |
| 6 | **å®Œå–„æµ‹è¯•è¦†ç›–ï¼ˆå½“å‰ä»…1ä¸ªæµ‹è¯•æ–‡ä»¶ï¼‰** | ç¼ºé™·ç‡â†“60%ï¼Œé‡æ„ä¿¡å¿ƒâ†‘ |
| 7 | **é…ç½®ç®¡ç†ä¸ç¯å¢ƒå˜é‡ç±»å‹å®‰å…¨åŒ–** | éƒ¨ç½²ç¨³å®šæ€§â†‘ï¼Œè¿ç»´æˆæœ¬â†“ |

---

## ğŸ“Š B. æ¶æ„ä¸æ¨¡å—åŒ–å»ºè®®

### B.1 å½“å‰æ¶æ„æ¦‚è§ˆï¼ˆä»ä»£ç æ¨æ–­ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        app/ (Next.js App Router)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   é¡µé¢å±‚ (Pages) â”‚  â”‚        API è·¯ç”±å±‚ (API Routes)       â”‚   â”‚
â”‚  â”‚  /pos           â”‚  â”‚  /api/orders/checkout/route.ts      â”‚   â”‚
â”‚  â”‚  /tables        â”‚  â”‚  /api/daily-closure/route.ts        â”‚   â”‚
â”‚  â”‚  /menu          â”‚  â”‚  /api/restaurant-tables/route.ts    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    components/ (UI ç»„ä»¶å±‚)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ pos-interface.tsx   â”‚  â”‚  PosCheckoutDialog.tsx (484è¡Œ)      â”‚ â”‚
â”‚  â”‚ (623è¡Œï¼Œå«ä¸šåŠ¡é€»è¾‘)  â”‚  â”‚  menu-management.tsx (621è¡Œ)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           hooks/ + lib/queries/ (çŠ¶æ€ç®¡ç† + æ•°æ®è·å–å±‚)           â”‚
â”‚  useCheckout.ts (359è¡Œ)  â”‚  usePosOrder.ts  â”‚  use-orders.ts    â”‚
â”‚  useTableTransfer.ts     â”‚  useRestaurantTables.ts               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    lib/api/ (API å®¢æˆ·ç«¯å±‚)                        â”‚
â”‚  fetcher.ts (ç»Ÿä¸€è¯·æ±‚)  â”‚  client.ts (API æ–¹æ³•å°è£…)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    db/schema.ts (æ•°æ®æ¨¡å‹å±‚)                      â”‚
â”‚  Drizzle ORM Schema  â”‚  13 è¡¨å®šä¹‰  â”‚  ç±»å‹å¯¼å‡º                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€æœ¯æ ˆè¯†åˆ«**ï¼š
- **å‰ç«¯**: Next.js 16 (App Router + Turbopack), React 19, TanStack Query 5
- **åç«¯**: Next.js API Routes (æ— ç‹¬ç«‹åç«¯æœåŠ¡)
- **æ•°æ®åº“**: PostgreSQL (Supabase) + Drizzle ORM
- **æµ‹è¯•**: Vitest + React Testing Library + MSW
- **UI**: TailwindCSS + Radix UI (shadcn/ui)

### B.2 ä¸»è¦é—®é¢˜

| é—®é¢˜ç±»åˆ« | å…·ä½“è¡¨ç° | å½±å“èŒƒå›´ | ä¸¥é‡ç¨‹åº¦ |
|---------|---------|---------|---------|
| **é«˜è€¦åˆ** | `pos-interface.tsx` ç›´æ¥è°ƒç”¨ `fetch` API è€Œéé€šè¿‡ `lib/api/client.ts` | POS æ¨¡å— | ğŸ”´ é«˜ |
| **å·¨å‹ç»„ä»¶** | `checkout/route.ts` 742è¡ŒåŒ…å«å®Œæ•´ä¸šåŠ¡é€»è¾‘ï¼Œæ— æœåŠ¡å±‚æŠ½è±¡ | ç»“è´¦å…¨æµç¨‹ | ğŸ”´ é«˜ |
| **é‡å¤é€»è¾‘** | `parseMoney()` åœ¨å¤šä¸ª API è·¯ç”±ä¸­é‡å¤å®šä¹‰ | æ‰€æœ‰é‡‘é¢å¤„ç† | ğŸŸ¡ ä¸­ |
| **éšå¼ä¾èµ–** | ç»„ä»¶ç›´æ¥ä¾èµ– URL å‚æ•° (`searchParams`)ï¼Œæµ‹è¯•å›°éš¾ | POS/Tables | ğŸŸ¡ ä¸­ |
| **ç¼ºå¤±æŠ½è±¡** | API è·¯ç”±ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œæ—  Repository æ¨¡å¼ | æ‰€æœ‰ CRUD | ğŸŸ¡ ä¸­ |
| **æµ‹è¯•çœŸç©º** | ä»… 1 ä¸ªå‰ç«¯æµ‹è¯•æ–‡ä»¶ï¼Œ0 ä¸ªåç«¯æœåŠ¡æµ‹è¯• | å…¨é¡¹ç›® | ğŸ”´ é«˜ |

### B.3 å»ºè®®çš„ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Presentation Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   app/ (Pages)     â”‚  â”‚   components/ (Pure UI)                 â”‚  â”‚
â”‚  â”‚   - Routing only   â”‚  â”‚   - Dumb components                     â”‚  â”‚
â”‚  â”‚   - SSR/SSG        â”‚  â”‚   - Props-driven                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Application Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   hooks/features/  (Feature-specific hooks)                   â”‚   â”‚
â”‚  â”‚   - useCheckoutFlow.ts (orchestration)                        â”‚   â”‚
â”‚  â”‚   - usePosSession.ts (state management)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   lib/services/  (Business Logic Services)                   â”‚   â”‚
â”‚  â”‚   - CheckoutService.ts                                        â”‚   â”‚
â”‚  â”‚   - OrderService.ts                                           â”‚   â”‚
â”‚  â”‚   - DailyClosureService.ts                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Domain Layer (NEW)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   lib/domain/  (Core Business Entities & Rules)               â”‚   â”‚
â”‚  â”‚   - Order.ts (entity, value objects, business rules)          â”‚   â”‚
â”‚  â”‚   - Money.ts (value object with operations)                   â”‚   â”‚
â”‚  â”‚   - Checkout.ts (domain logic)                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Infrastructure Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   app/api/ (Routes) â”‚  â”‚   lib/repositories/                  â”‚   â”‚
â”‚  â”‚   - Thin controllersâ”‚  â”‚   - OrderRepository.ts               â”‚   â”‚
â”‚  â”‚   - Validation only â”‚  â”‚   - TableRepository.ts               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   db/schema.ts + lib/db.ts (Database Access)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### B.4 ä¾èµ–è§„åˆ™

| å±‚çº§ | å¯ä¾èµ– | ç¦æ­¢ä¾èµ– |
|-----|-------|---------|
| Presentation | Application, Domain | Infrastructure (ç›´æ¥æ•°æ®åº“è®¿é—®) |
| Application | Domain, Infrastructure interfaces | å…·ä½“ Infrastructure å®ç° |
| Domain | æ— å¤–éƒ¨ä¾èµ– | ä»»ä½•å…¶ä»–å±‚ |
| Infrastructure | Domain (å®ç°æ¥å£) | Application, Presentation |

---

## ğŸ“‹ C. ä»£ç å±‚é¢æ”¹è¿›æ¸…å•

### C.1 ç›®å½•ç»“æ„ä¼˜åŒ–

| é—®é¢˜ | å»ºè®® | ç¤ºä¾‹ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | å½±å“èŒƒå›´ |
|-----|------|-----|-------|-------|---------|
| `hooks/` ä¸ `lib/queries/` èŒè´£é‡å  | åˆå¹¶è‡³ `hooks/` æˆ–ç»Ÿä¸€è‡³ `lib/queries/` | ä¿ç•™ `lib/queries/` ä½œä¸ºæ•°æ®å±‚ï¼Œ`hooks/` ä»…å­˜æ”¾ UI ç›¸å…³ hooks | P1 | M | å…¨é¡¹ç›® |
| æ—  Service å±‚ | æ–°å»º `lib/services/` | è§ B.3 æ¶æ„å›¾ | P0 | L | API è·¯ç”± |
| ç»„ä»¶æœªæŒ‰åŠŸèƒ½åŸŸç»„ç»‡ | å®Œå–„ `components/features/` ç»“æ„ | å·²æœ‰è‰¯å¥½åŸºç¡€ï¼Œç»§ç»­æ¨è¿› | P2 | S | ç»„ä»¶ |

**ç›®å½•ç»“æ„å»ºè®®**ï¼š
```
lib/
â”œâ”€â”€ api/            # API å®¢æˆ·ç«¯ (ä¿æŒç°æœ‰)
â”œâ”€â”€ constants/      # å¸¸é‡å®šä¹‰ (ä¿æŒç°æœ‰)
â”œâ”€â”€ domain/         # [NEW] é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ Order.ts
â”‚   â”œâ”€â”€ Money.ts
â”‚   â””â”€â”€ Checkout.ts
â”œâ”€â”€ services/       # [NEW] ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ CheckoutService.ts
â”‚   â””â”€â”€ OrderService.ts
â”œâ”€â”€ repositories/   # [NEW] æ•°æ®è®¿é—®æŠ½è±¡
â”‚   â””â”€â”€ OrderRepository.ts
â””â”€â”€ queries/        # React Query hooks (ä¿æŒç°æœ‰)
```

### C.2 å‘½åè§„èŒƒ

| é—®é¢˜ | å½“å‰çŠ¶æ€ | å»ºè®® | ä¼˜å…ˆçº§ | å·¥ä½œé‡ |
|-----|---------|-----|-------|-------|
| API ç±»å‹ä¸ DB ç±»å‹å‘½åæ··æ·† | `types/api.ts` ä¸­ `OrderResponse` ä¸ `db/schema.ts` ä¸­ `Order` | API ç±»å‹åŠ  `Dto` åç¼€ï¼š`OrderResponseDto` | P2 | S |
| Hook å‘½åä¸ä¸€è‡´ | `useCheckout` vs `useTableOrderQuery` | ç»Ÿä¸€ï¼šæŸ¥è¯¢ç”¨ `use*Query`ï¼Œå˜æ›´ç”¨ `use*Mutation` | P2 | S |

### C.3 é”™è¯¯å¤„ç†

| é—®é¢˜ | æ–‡ä»¶ä½ç½® | å»ºè®® | ç¤ºä¾‹ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ |
|-----|---------|-----|-----|-------|-------|
| API è·¯ç”±é”™è¯¯å¤„ç†é‡å¤ | æ‰€æœ‰ `app/api/*/route.ts` | æŠ½å–ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶ | è§ä¸‹æ–¹ä»£ç  | P0 | M |
| å®¢æˆ·ç«¯é”™è¯¯å±•ç¤ºä¸ä¸€è‡´ | `pos-interface.tsx` L284-298 | ä½¿ç”¨ `lib/constants/error-messages.ts` ç»Ÿä¸€æ˜ å°„ | å·²æœ‰è‰¯å¥½åŸºç¡€ | P1 | S |

**å»ºè®®çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶**ï¼š
```typescript
// lib/api/middleware/error-handler.ts
import { NextResponse } from "next/server"
import { ZodError } from "zod"

export function withErrorHandler<T>(
  handler: () => Promise<T>
): Promise<NextResponse> {
  return handler()
    .then((data) => NextResponse.json(data))
    .catch((err) => {
      if (err instanceof ZodError) {
        return NextResponse.json(
          { error: "Validation failed", code: "VALIDATION_ERROR", detail: err.flatten() },
          { status: 400 }
        )
      }
      if (err.code === "23505") {
        return NextResponse.json(
          { error: "Duplicate entry", code: "DUPLICATE_ENTRY" },
          { status: 409 }
        )
      }
      console.error("[API Error]", err)
      return NextResponse.json(
        { error: "Internal server error", code: "INTERNAL_ERROR" },
        { status: 500 }
      )
    })
}
```

### C.4 æ—¥å¿—ä¸å¯è§‚æµ‹æ€§

| é—®é¢˜ | å½“å‰çŠ¶æ€ | å»ºè®® | ä¼˜å…ˆçº§ | å·¥ä½œé‡ |
|-----|---------|-----|-------|-------|
| ä»… `console.error` æ—¥å¿— | æ— ç»“æ„åŒ–æ—¥å¿— | å¼•å…¥ç»“æ„åŒ–æ—¥å¿—ï¼ˆæ¨è pinoï¼‰ | P1 | M |
| æ— è¯·æ±‚è¿½è¸ª | - | æ·»åŠ  request ID ä¸­é—´ä»¶ | P2 | S |

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```typescript
// lib/logger.ts
type LogLevel = "info" | "warn" | "error"

export function log(level: LogLevel, message: string, meta?: Record<string, unknown>) {
  const entry = {
    timestamp: new Date().toISOString(),
    level,
    message,
    ...meta,
  }
  console[level === "error" ? "error" : "log"](JSON.stringify(entry))
}
```

### C.5 é…ç½®ç®¡ç†

| é—®é¢˜ | å½“å‰çŠ¶æ€ | å»ºè®® | ç¤ºä¾‹ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ |
|-----|---------|-----|-----|-------|-------|
| ç¯å¢ƒå˜é‡æ— ç±»å‹å®‰å…¨ | ç›´æ¥ `process.env.X` | ä½¿ç”¨ Zod éªŒè¯ç¯å¢ƒå˜é‡ | è§ä¸‹æ–¹ä»£ç  | P1 | S |

```typescript
// lib/env.ts
import { z } from "zod"

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
})

export const env = envSchema.parse({
  DATABASE_URL: process.env.DATABASE_URL,
  NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
  NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY,
})
```

### C.6 ç±»å‹ä¸æ¥å£

| é—®é¢˜ | æ–‡ä»¶ä½ç½® | å»ºè®® | ä¼˜å…ˆçº§ | å·¥ä½œé‡ |
|-----|---------|-----|-------|-------|
| ç±»å‹æ–­è¨€è¿‡å¤š | `checkout/route.ts` L317-320, L378-379 | ä¿®å¤ Drizzle Schema ç±»å‹æ¨æ–­ | P1 | M |
| é­”æ³•å­—ç¬¦ä¸² | æ”¯ä»˜æ–¹å¼ `"cash"`, `"card"` | ä½¿ç”¨ `lib/constants/payment-methods.ts` çš„æšä¸¾ | P2 | S |

**é—®é¢˜ç¤ºä¾‹** (`checkout/route.ts`):
```typescript
// å½“å‰: ç±»å‹æ–­è¨€
const existingTotalAmount = parseNumeric(
  (order as { totalAmount?: unknown }).totalAmount ?? 0,
)

// å»ºè®®: ä¿®å¤ Schema æˆ–å®šä¹‰å®Œæ•´ç±»å‹
type OrderWithTotals = Order & { totalAmount: string; paidAmount: string }
const existingTotalAmount = parseMoney(order.totalAmount)
```

### C.7 æ€§èƒ½ä¼˜åŒ–

| é—®é¢˜ | æ–‡ä»¶ä½ç½® | å»ºè®® | ä¼˜å…ˆçº§ | å·¥ä½œé‡ |
|-----|---------|-----|-------|-------|
| React Query ç¼“å­˜ç­–ç•¥ä¸ä¸€è‡´ | `lib/queries/use-orders.ts` L25-26 | ç»Ÿä¸€ staleTime é…ç½® | P2 | S |
| ç»„ä»¶æ—  memo ä¼˜åŒ– | å¤§å‹åˆ—è¡¨ç»„ä»¶ | é€‚åº¦æ·»åŠ  `React.memo` | P2 | S |

---

## ğŸ§ª D. å¯æµ‹è¯•æ€§ä¸è´¨é‡ä¿éšœ

### D.1 å½“å‰æµ‹è¯•çŠ¶æ€

```
__tests__/
â”œâ”€â”€ reports-view.test.tsx    # å”¯ä¸€çš„ç»„ä»¶æµ‹è¯•
â””â”€â”€ mocks/
    â””â”€â”€ ...

app/api/__tests__/
â”œâ”€â”€ menu-items.test.ts       # API æµ‹è¯•
â”œâ”€â”€ orders.test.ts
â”œâ”€â”€ restaurant-tables.test.ts
â””â”€â”€ transactions.test.ts

lib/__tests__/
â””â”€â”€ ...
```

**è¦†ç›–ç‡è¯„ä¼°**ï¼šå½“å‰æµ‹è¯•è¦†ç›–æä½ï¼ˆä¼°è®¡ < 10%ï¼‰

### D.2 æµ‹è¯•ç­–ç•¥å»ºè®®

| æµ‹è¯•ç±»å‹ | ç›®æ ‡è¦†ç›–ç‡ | é‡ç‚¹æ¨¡å— | å·¥å…· |
|---------|-----------|---------|-----|
| å•å…ƒæµ‹è¯• | > 70% | `lib/money.ts`, `lib/order-utils.ts`, Domain å±‚ | Vitest |
| é›†æˆæµ‹è¯• | > 50% | API Routes, Services | Vitest + MSW |
| ç»„ä»¶æµ‹è¯• | > 40% | æ ¸å¿ƒä¸šåŠ¡ç»„ä»¶ | RTL + Vitest |
| E2E æµ‹è¯• | å…³é”®è·¯å¾„ | ç»“è´¦æµç¨‹ã€æ—¥ç»“ | Playwright (æœªæ¥) |

### D.3 å…³é”®å¯æµ‹ç‚¹ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

1. **P0: `lib/money.ts`** - æ ¸å¿ƒé‡‘é¢è®¡ç®—ï¼Œå¿…é¡» 100% è¦†ç›–
2. **P0: `lib/order-utils.ts`** - è®¢å•æ‰¹æ¬¡æ„å»ºé€»è¾‘
3. **P1: `hooks/useCheckout.ts`** - ç»“è´¦çŠ¶æ€æœºï¼ˆ359è¡Œå¤æ‚é€»è¾‘ï¼‰
4. **P1: `app/api/orders/checkout/route.ts`** - æ ¸å¿ƒä¸šåŠ¡æµç¨‹
5. **P2: å„ Service å±‚ï¼ˆå¾…åˆ›å»ºï¼‰**

### D.4 Mock/ä¾èµ–æ³¨å…¥ç­–ç•¥

**å½“å‰é—®é¢˜**ï¼šç»„ä»¶ç›´æ¥è°ƒç”¨ `fetch()`ï¼Œéš¾ä»¥ mock

**å»ºè®®é‡æ„**ï¼š
```typescript
// é‡æ„å‰ (pos-interface.tsx L259-280)
const checkoutRes = await fetch("/api/orders/checkout", { ... })

// é‡æ„å (ä½¿ç”¨ lib/api/client.ts)
import { api } from "@/lib/api"
const result = await api.orders.checkout({ ... })
// æµ‹è¯•æ—¶å¯ mock api å¯¹è±¡
```

### D.5 CI å»ºè®®

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]
jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - run: pnpm install
      - run: pnpm lint              # ESLint
      - run: pnpm build             # Type check + Build
      - run: pnpm test:coverage     # Tests + Coverage
      - name: Coverage Gate
        run: |
          # è¦æ±‚æ ¸å¿ƒæ¨¡å—è¦†ç›–ç‡ > 60%
          if [ $(jq '.total.lines.pct' coverage/coverage-summary.json) -lt 60 ]; then
            echo "Coverage below 60%"
            exit 1
          fi
```

---

## ğŸ—“ï¸ E. æ¼”è¿›è·¯çº¿å›¾

### é˜¶æ®µ 1ï¼šä½é£é™©é«˜æ”¶ç›Š (0-2å¤©)

| ä»»åŠ¡ | æ”¶ç›Š | é£é™© | å›æ»šç­–ç•¥ |
|-----|------|-----|---------|
| æŠ½å– `lib/api/middleware/error-handler.ts` | ä»£ç ç»Ÿä¸€æ€§ | ä½ | Git revert |
| åˆ›å»º `lib/env.ts` ç¯å¢ƒå˜é‡ç±»å‹æ ¡éªŒ | å¯åŠ¨æ—¶é”™è¯¯æ£€æµ‹ | ä½ | åˆ é™¤æ–‡ä»¶ |
| ç»Ÿä¸€ `pos-interface.tsx` ä½¿ç”¨ `lib/api/client.ts` | ä»£ç ä¸€è‡´æ€§ | ä½ | Git revert |
| æ·»åŠ  `lib/money.ts` å®Œæ•´æµ‹è¯•ï¼ˆç›®æ ‡100%ï¼‰ | æ ¸å¿ƒé€»è¾‘ä¿éšœ | æ—  | N/A |

### é˜¶æ®µ 2ï¼šç»“æ„æ€§é‡æ„ (1-2å‘¨)

| ä»»åŠ¡ | æ”¶ç›Š | é£é™© | å›æ»šç­–ç•¥ |
|-----|------|-----|---------|
| åˆ›å»º `CheckoutService` æŠ½å– 742 è¡Œä¸šåŠ¡é€»è¾‘ | å¯æµ‹è¯•æ€§â†‘ | ä¸­ | Feature flag |
| æ‹†åˆ† `pos-interface.tsx` ä¸º 3-4 ä¸ªå­ç»„ä»¶ | ç»´æŠ¤æ€§â†‘ | ä¸­ | ä¿ç•™æ—§ç»„ä»¶åˆ«å |
| å»ºç«‹ `lib/domain/Money.ts` å€¼å¯¹è±¡ | ä¸šåŠ¡æ¦‚å¿µæ¸…æ™°åŒ– | ä½ | N/A |
| è¡¥å…… API è·¯ç”±é›†æˆæµ‹è¯• | å›å½’ä¿éšœ | æ—  | N/A |

### é˜¶æ®µ 3ï¼šæ¶æ„æ¼”è¿› (1-2æœˆ)

| ä»»åŠ¡ | æ”¶ç›Š | é£é™© | å›æ»šç­–ç•¥ |
|-----|------|-----|---------|
| å®Œæ•´ Domain Layer å®ç° | ä¸šåŠ¡è§„åˆ™å¯å¤ç”¨ | ä¸­ | æ¸è¿›è¿ç§» |
| Repository æ¨¡å¼å¼•å…¥ | æ•°æ®è®¿é—®æŠ½è±¡ | ä¸­ | æ¥å£é€‚é…å™¨ |
| SSR ä¼˜åŒ– + æ€§èƒ½ç›‘æ§ | ç”¨æˆ·ä½“éªŒâ†‘ | ä½ | Feature flag |
| Playwright E2E æµ‹è¯• | å…¨æµç¨‹ä¿éšœ | ä½ | N/A |

---

## âš ï¸ F. é£é™©ä¸æƒè¡¡

### F.1 å·²è¯†åˆ«é£é™©

| æ”¹åŠ¨ | æ½œåœ¨å½±å“ | ç¼“è§£æªæ–½ |
|-----|---------|---------|
| æ‹†åˆ†å¤§ç»„ä»¶ | å¯èƒ½å¼•å…¥ props drilling | é€‚åº¦ä½¿ç”¨ Context æˆ–ç»„åˆç»„ä»¶æ¨¡å¼ |
| æŠ½å– Service å±‚ | API è·¯ç”±è°ƒç”¨é“¾å˜é•¿ | ç¡®ä¿æ¥å£ç®€æ´ï¼Œé¿å…è¿‡åº¦æŠ½è±¡ |
| å¼•å…¥ Domain å±‚ | å­¦ä¹ æ›²çº¿ | ä»æ ¸å¿ƒå®ä½“ï¼ˆOrder, Moneyï¼‰å¼€å§‹ï¼Œæ¸è¿›æ¨å¹¿ |

### F.2 å»ºè®®çš„å–èˆ

| å–èˆé¡¹ | å»ºè®®é€‰æ‹© | åŸå›  |
|-------|---------|-----|
| Repository æ¨¡å¼ vs ç›´æ¥ Drizzle | **æš‚ç¼“** Repository | Drizzle å·²æä¾›è‰¯å¥½æŠ½è±¡ï¼Œä¼˜å…ˆè§£å†³æ›´ç´§è¿«é—®é¢˜ |
| å®Œæ•´ DDD vs è½»é‡ Service | **è½»é‡ Service** | å›¢é˜Ÿè§„æ¨¡/é¡¹ç›®å¤æ‚åº¦æš‚ä¸éœ€è¦å®Œæ•´ DDD |
| å…¨é¢é‡æ„ vs æ¸è¿›æ”¹è¿› | **æ¸è¿›æ”¹è¿›** | ä¿æŒä¸šåŠ¡è¿ç»­æ€§ï¼Œé™ä½é£é™© |

---

## ğŸ“ é™„å½•ï¼šå…³é”®æ–‡ä»¶å¼•ç”¨

| æ–‡ä»¶ | è¡Œæ•° | ä¸»è¦é—®é¢˜ |
|-----|-----|---------|
| [pos-interface.tsx](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/components/pos-interface.tsx) | 623 | ç»„ä»¶è¿‡å¤§ï¼Œå«ä¸šåŠ¡é€»è¾‘ |
| [checkout/route.ts](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/app/api/orders/checkout/route.ts) | 742 | æ—  Service æŠ½è±¡ |
| [menu-management.tsx](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/components/menu-management.tsx) | 621 | ç»„ä»¶è¿‡å¤§ |
| [useCheckout.ts](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/hooks/useCheckout.ts) | 359 | å¤æ‚çŠ¶æ€æœºéœ€æµ‹è¯• |
| [db/schema.ts](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/db/schema.ts) | 349 | åŸºç¡€è‰¯å¥½ï¼Œç±»å‹æ¨æ–­å¯ä¼˜åŒ– |
| [types/api.ts](file:///Users/zhuyuxia/Documents/GitHub/easyFactu/types/api.ts) | 342 | API å¥‘çº¦å®šä¹‰è‰¯å¥½ |

---

> ğŸ“ æœ¬è¯„å®¡åŸºäº 2025-12-26 ä»£ç åº“å¿«ç…§ç”Ÿæˆï¼Œå»ºè®®æ¯å­£åº¦æ›´æ–°ä¸€æ¬¡ã€‚
